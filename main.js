!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("Vue")):"function"==typeof define&&define.amd?define(["Vue"],t):"object"==typeof exports?exports.MyVueComponents=t(require("Vue")):e.MyVueComponents=t(e.Vue)}(self,(function(e){return function(){var t={897:function(e,t,r){"use strict";r.r(t);var n=r(601),i=r.n(n),o=r(314),a=r.n(o)()(i());a.push([e.id,"\n.phone-button[data-v-321397a9] {\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  border-radius: 40px;\n  position: fixed;\n  bottom: 20px;\n  right: 20px;\n  cursor: pointer;\n}\n",""]),t.default=a},314:function(e){"use strict";e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var r="",n=void 0!==t[5];return t[4]&&(r+="@supports (".concat(t[4],") {")),t[2]&&(r+="@media ".concat(t[2]," {")),n&&(r+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),r+=e(t),n&&(r+="}"),t[2]&&(r+="}"),t[4]&&(r+="}"),r})).join("")},t.i=function(e,r,n,i,o){"string"==typeof e&&(e=[[null,e,void 0]]);var a={};if(n)for(var s=0;s<this.length;s++){var c=this[s][0];null!=c&&(a[c]=!0)}for(var d=0;d<e.length;d++){var u=[].concat(e[d]);n&&a[u[0]]||(void 0!==o&&(void 0===u[5]||(u[1]="@layer".concat(u[5].length>0?" ".concat(u[5]):""," {").concat(u[1],"}")),u[5]=o),r&&(u[2]?(u[1]="@media ".concat(u[2]," {").concat(u[1],"}"),u[2]=r):u[2]=r),i&&(u[4]?(u[1]="@supports (".concat(u[4],") {").concat(u[1],"}"),u[4]=i):u[4]="".concat(i)),t.push(u))}},t}},601:function(e){"use strict";e.exports=function(e){return e[1]}},262:function(e,t){"use strict";t.A=(e,t)=>{const r=e.__vccOpts||e;for(const[e,n]of t)r[e]=n;return r}},172:function(e,t,r){var n=r(897);n.__esModule&&(n=n.default),"string"==typeof n&&(n=[[e.id,n,""]]),n.locals&&(e.exports=n.locals),(0,r(534).A)("ddec9d12",n,!1,{})},534:function(e,t,r){"use strict";function n(e,t){for(var r=[],n={},i=0;i<t.length;i++){var o=t[i],a=o[0],s={id:e+":"+i,css:o[1],media:o[2],sourceMap:o[3]};n[a]?n[a].parts.push(s):r.push(n[a]={id:a,parts:[s]})}return r}r.d(t,{A:function(){return v}});var i="undefined"!=typeof document;if("undefined"!=typeof DEBUG&&DEBUG&&!i)throw new Error("vue-style-loader cannot be used in a non-browser environment. Use { target: 'node' } in your Webpack config to indicate a server-rendering environment.");var o={},a=i&&(document.head||document.getElementsByTagName("head")[0]),s=null,c=0,d=!1,u=function(){},l=null,f="data-vue-ssr-id",p="undefined"!=typeof navigator&&/msie [6-9]\b/.test(navigator.userAgent.toLowerCase());function v(e,t,r,i){d=r,l=i||{};var a=n(e,t);return m(a),function(t){for(var r=[],i=0;i<a.length;i++){var s=a[i];(c=o[s.id]).refs--,r.push(c)}for(t?m(a=n(e,t)):a=[],i=0;i<r.length;i++){var c;if(0===(c=r[i]).refs){for(var d=0;d<c.parts.length;d++)c.parts[d]();delete o[c.id]}}}}function m(e){for(var t=0;t<e.length;t++){var r=e[t],n=o[r.id];if(n){n.refs++;for(var i=0;i<n.parts.length;i++)n.parts[i](r.parts[i]);for(;i<r.parts.length;i++)n.parts.push(h(r.parts[i]));n.parts.length>r.parts.length&&(n.parts.length=r.parts.length)}else{var a=[];for(i=0;i<r.parts.length;i++)a.push(h(r.parts[i]));o[r.id]={id:r.id,refs:1,parts:a}}}}function g(){var e=document.createElement("style");return e.type="text/css",a.appendChild(e),e}function h(e){var t,r,n=document.querySelector("style["+f+'~="'+e.id+'"]');if(n){if(d)return u;n.parentNode.removeChild(n)}if(p){var i=c++;n=s||(s=g()),t=y.bind(null,n,i,!1),r=y.bind(null,n,i,!0)}else n=g(),t=S.bind(null,n),r=function(){n.parentNode.removeChild(n)};return t(e),function(n){if(n){if(n.css===e.css&&n.media===e.media&&n.sourceMap===e.sourceMap)return;t(e=n)}else r()}}var b,w=(b=[],function(e,t){return b[e]=t,b.filter(Boolean).join("\n")});function y(e,t,r,n){var i=r?"":n.css;if(e.styleSheet)e.styleSheet.cssText=w(t,i);else{var o=document.createTextNode(i),a=e.childNodes;a[t]&&e.removeChild(a[t]),a.length?e.insertBefore(o,a[t]):e.appendChild(o)}}function S(e,t){var r=t.css,n=t.media,i=t.sourceMap;if(n&&e.setAttribute("media",n),l.ssrId&&e.setAttribute(f,t.id),i&&(r+="\n/*# sourceURL="+i.sources[0]+" */",r+="\n/*# sourceMappingURL=data:application/json;base64,"+btoa(unescape(encodeURIComponent(JSON.stringify(i))))+" */"),e.styleSheet)e.styleSheet.cssText=r;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(r))}}},900:function(e){e.exports=function e(t,r,n){function i(a,s){if(!r[a]){if(!t[a]){if(o)return o(a,!0);var c=new Error("Cannot find module '"+a+"'");throw c.code="MODULE_NOT_FOUND",c}var d=r[a]={exports:{}};t[a][0].call(d.exports,(function(e){return i(t[a][1][e]||e)}),d,d.exports,e,t,r,n)}return r[a].exports}for(var o=void 0,a=0;a<n.length;a++)i(n[a]);return i}({1:[function(e,t,r){"use strict";var n={generateIdentifier:function(){return Math.random().toString(36).substr(2,10)}};n.localCName=n.generateIdentifier(),n.splitLines=function(e){return e.trim().split("\n").map((function(e){return e.trim()}))},n.splitSections=function(e){return e.split("\nm=").map((function(e,t){return(t>0?"m="+e:e).trim()+"\r\n"}))},n.matchPrefix=function(e,t){return n.splitLines(e).filter((function(e){return 0===e.indexOf(t)}))},n.parseCandidate=function(e){for(var t,r={foundation:(t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" "))[0],component:t[1],protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],port:parseInt(t[5],10),type:t[7]},n=8;n<t.length;n+=2)switch(t[n]){case"raddr":r.relatedAddress=t[n+1];break;case"rport":r.relatedPort=parseInt(t[n+1],10);break;case"tcptype":r.tcpType=t[n+1]}return r},n.writeCandidate=function(e){var t=[];t.push(e.foundation),t.push(e.component),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.ip),t.push(e.port);var r=e.type;return t.push("typ"),t.push(r),"host"!==r&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),"candidate:"+t.join(" ")},n.parseRtpMap=function(e){var t=e.substr(9).split(" "),r={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),r.name=t[0],r.clockRate=parseInt(t[1],10),r.numChannels=3===t.length?parseInt(t[2],10):1,r},n.writeRtpMap=function(e){var t=e.payloadType;return void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType),"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==e.numChannels?"/"+e.numChannels:"")+"\r\n"},n.parseExtmap=function(e){var t=e.substr(9).split(" ");return{id:parseInt(t[0],10),uri:t[1]}},n.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+" "+e.uri+"\r\n"},n.parseFmtp=function(e){for(var t,r={},n=e.substr(e.indexOf(" ")+1).split(";"),i=0;i<n.length;i++)r[(t=n[i].trim().split("="))[0].trim()]=t[1];return r},n.writeFmtp=function(e){var t="",r=e.payloadType;if(void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){var n=[];Object.keys(e.parameters).forEach((function(t){n.push(t+"="+e.parameters[t])})),t+="a=fmtp:"+r+" "+n.join(";")+"\r\n"}return t},n.parseRtcpFb=function(e){var t=e.substr(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},n.writeRtcpFb=function(e){var t="",r=e.payloadType;return void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach((function(e){t+="a=rtcp-fb:"+r+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"})),t},n.parseSsrcMedia=function(e){var t=e.indexOf(" "),r={ssrc:parseInt(e.substr(7,t-7),10)},n=e.indexOf(":",t);return n>-1?(r.attribute=e.substr(t+1,n-t-1),r.value=e.substr(n+1)):r.attribute=e.substr(t+1),r},n.getDtlsParameters=function(e,t){var r=n.splitLines(e),i=(r=r.concat(n.splitLines(t))).filter((function(e){return 0===e.indexOf("a=fingerprint:")}))[0].substr(14);return{role:"auto",fingerprints:[{algorithm:i.split(" ")[0],value:i.split(" ")[1]}]}},n.writeDtlsParameters=function(e,t){var r="a=setup:"+t+"\r\n";return e.fingerprints.forEach((function(e){r+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"})),r},n.getIceParameters=function(e,t){var r=n.splitLines(e);return{usernameFragment:(r=r.concat(n.splitLines(t))).filter((function(e){return 0===e.indexOf("a=ice-ufrag:")}))[0].substr(12),password:r.filter((function(e){return 0===e.indexOf("a=ice-pwd:")}))[0].substr(10)}},n.writeIceParameters=function(e){return"a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n"},n.parseRtpParameters=function(e){for(var t={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},r=n.splitLines(e)[0].split(" "),i=3;i<r.length;i++){var o=r[i],a=n.matchPrefix(e,"a=rtpmap:"+o+" ")[0];if(a){var s=n.parseRtpMap(a),c=n.matchPrefix(e,"a=fmtp:"+o+" ");switch(s.parameters=c.length?n.parseFmtp(c[0]):{},s.rtcpFeedback=n.matchPrefix(e,"a=rtcp-fb:"+o+" ").map(n.parseRtcpFb),t.codecs.push(s),s.name.toUpperCase()){case"RED":case"ULPFEC":t.fecMechanisms.push(s.name.toUpperCase())}}}return n.matchPrefix(e,"a=extmap:").forEach((function(e){t.headerExtensions.push(n.parseExtmap(e))})),t},n.writeRtpDescription=function(e,t){var r="";return r+="m="+e+" ",r+=t.codecs.length>0?"9":"0",r+=" UDP/TLS/RTP/SAVPF ",r+=t.codecs.map((function(e){return void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType})).join(" ")+"\r\n",r+="c=IN IP4 0.0.0.0\r\n",r+="a=rtcp:9 IN IP4 0.0.0.0\r\n",t.codecs.forEach((function(e){r+=n.writeRtpMap(e),r+=n.writeFmtp(e),r+=n.writeRtcpFb(e)})),r+="a=rtcp-mux\r\n"},n.parseRtpEncodingParameters=function(e){var t,r=[],i=n.parseRtpParameters(e),o=-1!==i.fecMechanisms.indexOf("RED"),a=-1!==i.fecMechanisms.indexOf("ULPFEC"),s=n.matchPrefix(e,"a=ssrc:").map((function(e){return n.parseSsrcMedia(e)})).filter((function(e){return"cname"===e.attribute})),c=s.length>0&&s[0].ssrc,d=n.matchPrefix(e,"a=ssrc-group:FID").map((function(e){var t=e.split(" ");return t.shift(),t.map((function(e){return parseInt(e,10)}))}));d.length>0&&d[0].length>1&&d[0][0]===c&&(t=d[0][1]),i.codecs.forEach((function(e){if("RTX"===e.name.toUpperCase()&&e.parameters.apt){var n={ssrc:c,codecPayloadType:parseInt(e.parameters.apt,10),rtx:{payloadType:e.payloadType,ssrc:t}};r.push(n),o&&((n=JSON.parse(JSON.stringify(n))).fec={ssrc:t,mechanism:a?"red+ulpfec":"red"},r.push(n))}})),0===r.length&&c&&r.push({ssrc:c});var u=n.matchPrefix(e,"b=");return u.length&&(0===u[0].indexOf("b=TIAS:")?u=parseInt(u[0].substr(7),10):0===u[0].indexOf("b=AS:")&&(u=parseInt(u[0].substr(5),10)),r.forEach((function(e){e.maxBitrate=u}))),r},n.writeSessionBoilerplate=function(){return"v=0\r\no=thisisadapterortc 8169639915646943137 2 IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},n.writeMediaSection=function(e,t,r,i){var o=n.writeRtpDescription(e.kind,t);if(o+=n.writeIceParameters(e.iceGatherer.getLocalParameters()),o+=n.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===r?"actpass":"active"),o+="a=mid:"+e.mid+"\r\n",e.rtpSender&&e.rtpReceiver?o+="a=sendrecv\r\n":e.rtpSender?o+="a=sendonly\r\n":e.rtpReceiver?o+="a=recvonly\r\n":o+="a=inactive\r\n",e.rtpSender){var a="msid:"+i.id+" "+e.rtpSender.track.id+"\r\n";o+="a="+a,o+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+a}return o+"a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+n.localCName+"\r\n"},n.getDirection=function(e,t){for(var r=n.splitLines(e),i=0;i<r.length;i++)switch(r[i]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[i].substr(2)}return t?n.getDirection(t):"sendrecv"},t.exports=n},{}],2:[function(e,t,r){"use strict";!function(){var r=e("./utils").log,n=e("./utils").browserDetails;t.exports.browserDetails=n,t.exports.extractVersion=e("./utils").extractVersion,t.exports.disableLog=e("./utils").disableLog;var i=e("./chrome/chrome_shim")||null,o=e("./edge/edge_shim")||null,a=e("./firefox/firefox_shim")||null,s=e("./safari/safari_shim")||null;switch(n.browser){case"opera":case"chrome":if(!i||!i.shimPeerConnection)return void r("Chrome shim is not included in this adapter release.");r("adapter.js shimming chrome."),t.exports.browserShim=i,i.shimGetUserMedia(),i.shimMediaStream(),i.shimSourceObject(),i.shimPeerConnection(),i.shimOnTrack();break;case"firefox":if(!a||!a.shimPeerConnection)return void r("Firefox shim is not included in this adapter release.");r("adapter.js shimming firefox."),t.exports.browserShim=a,a.shimGetUserMedia(),a.shimSourceObject(),a.shimPeerConnection(),a.shimOnTrack();break;case"edge":if(!o||!o.shimPeerConnection)return void r("MS edge shim is not included in this adapter release.");r("adapter.js shimming edge."),t.exports.browserShim=o,o.shimGetUserMedia(),o.shimPeerConnection();break;case"safari":if(!s)return void r("Safari shim is not included in this adapter release.");r("adapter.js shimming safari."),t.exports.browserShim=s,s.shimGetUserMedia();break;default:r("Unsupported browser!")}}()},{"./chrome/chrome_shim":3,"./edge/edge_shim":5,"./firefox/firefox_shim":7,"./safari/safari_shim":9,"./utils":10}],3:[function(e,t,r){"use strict";var n=e("../utils.js").log,i=e("../utils.js").browserDetails,o={shimMediaStream:function(){window.MediaStream=window.MediaStream||window.webkitMediaStream},shimOnTrack:function(){"object"==typeof window&&window.RTCPeerConnection&&!("ontrack"in window.RTCPeerConnection.prototype)&&Object.defineProperty(window.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(e){var t=this;this._ontrack&&(this.removeEventListener("track",this._ontrack),this.removeEventListener("addstream",this._ontrackpoly)),this.addEventListener("track",this._ontrack=e),this.addEventListener("addstream",this._ontrackpoly=function(e){e.stream.addEventListener("addtrack",(function(r){var n=new Event("track");n.track=r.track,n.receiver={track:r.track},n.streams=[e.stream],t.dispatchEvent(n)})),e.stream.getTracks().forEach(function(t){var r=new Event("track");r.track=t,r.receiver={track:t},r.streams=[e.stream],this.dispatchEvent(r)}.bind(this))}.bind(this))}})},shimSourceObject:function(){"object"==typeof window&&window.HTMLMediaElement&&!("srcObject"in window.HTMLMediaElement.prototype)&&Object.defineProperty(window.HTMLMediaElement.prototype,"srcObject",{get:function(){return this._srcObject},set:function(e){var t=this;this._srcObject=e,this.src&&URL.revokeObjectURL(this.src),e?(this.src=URL.createObjectURL(e),e.addEventListener("addtrack",(function(){t.src&&URL.revokeObjectURL(t.src),t.src=URL.createObjectURL(e)})),e.addEventListener("removetrack",(function(){t.src&&URL.revokeObjectURL(t.src),t.src=URL.createObjectURL(e)}))):this.src=""}})},shimPeerConnection:function(){window.RTCPeerConnection=function(e,t){n("PeerConnection"),e&&e.iceTransportPolicy&&(e.iceTransports=e.iceTransportPolicy);var r=new webkitRTCPeerConnection(e,t);return r.getStats.bind(r),r},window.RTCPeerConnection.prototype=webkitRTCPeerConnection.prototype,webkitRTCPeerConnection.generateCertificate&&Object.defineProperty(window.RTCPeerConnection,"generateCertificate",{get:function(){return webkitRTCPeerConnection.generateCertificate}}),["createOffer","createAnswer"].forEach((function(e){var t=webkitRTCPeerConnection.prototype[e];webkitRTCPeerConnection.prototype[e]=function(){var e=this;if(arguments.length<1||1===arguments.length&&"object"==typeof arguments[0]){var r=1===arguments.length?arguments[0]:void 0;return new Promise((function(n,i){t.apply(e,[n,i,r])}))}return t.apply(this,arguments)}})),i.version<51&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(e){var t=webkitRTCPeerConnection.prototype[e];webkitRTCPeerConnection.prototype[e]=function(){var e=arguments,r=this,n=new Promise((function(n,i){t.apply(r,[e[0],n,i])}));return e.length<2?n:n.then((function(){e[1].apply(null,[])}),(function(t){e.length>=3&&e[2].apply(null,[t])}))}})),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(e){var t=webkitRTCPeerConnection.prototype[e];webkitRTCPeerConnection.prototype[e]=function(){return arguments[0]=new("addIceCandidate"===e?RTCIceCandidate:RTCSessionDescription)(arguments[0]),t.apply(this,arguments)}}));var e=RTCPeerConnection.prototype.addIceCandidate;RTCPeerConnection.prototype.addIceCandidate=function(){return null===arguments[0]?Promise.resolve():e.apply(this,arguments)}}};t.exports={shimMediaStream:o.shimMediaStream,shimOnTrack:o.shimOnTrack,shimSourceObject:o.shimSourceObject,shimPeerConnection:o.shimPeerConnection,shimGetUserMedia:e("./getusermedia")}},{"../utils.js":10,"./getusermedia":4}],4:[function(e,t,r){"use strict";var n=e("../utils.js").log;t.exports=function(){var e=function(e){if("object"!=typeof e||e.mandatory||e.optional)return e;var t={};return Object.keys(e).forEach((function(r){if("require"!==r&&"advanced"!==r&&"mediaSource"!==r){var n="object"==typeof e[r]?e[r]:{ideal:e[r]};void 0!==n.exact&&"number"==typeof n.exact&&(n.min=n.max=n.exact);var i=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==n.ideal){t.optional=t.optional||[];var o={};"number"==typeof n.ideal?(o[i("min",r)]=n.ideal,t.optional.push(o),(o={})[i("max",r)]=n.ideal,t.optional.push(o)):(o[i("",r)]=n.ideal,t.optional.push(o))}void 0!==n.exact&&"number"!=typeof n.exact?(t.mandatory=t.mandatory||{},t.mandatory[i("",r)]=n.exact):["min","max"].forEach((function(e){void 0!==n[e]&&(t.mandatory=t.mandatory||{},t.mandatory[i(e,r)]=n[e])}))}})),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},t=function(t,r){if((t=JSON.parse(JSON.stringify(t)))&&t.audio&&(t.audio=e(t.audio)),t&&"object"==typeof t.video){var i=t.video.facingMode;if((i=i&&("object"==typeof i?i:{ideal:i}))&&("user"===i.exact||"environment"===i.exact||"user"===i.ideal||"environment"===i.ideal)&&(!navigator.mediaDevices.getSupportedConstraints||!navigator.mediaDevices.getSupportedConstraints().facingMode)&&(delete t.video.facingMode,"environment"===i.exact||"environment"===i.ideal))return navigator.mediaDevices.enumerateDevices().then((function(o){var a=(o=o.filter((function(e){return"videoinput"===e.kind}))).find((function(e){return-1!==e.label.toLowerCase().indexOf("back")}))||o.length&&o[o.length-1];return a&&(t.video.deviceId=i.exact?{exact:a.deviceId}:{ideal:a.deviceId}),t.video=e(t.video),n("chrome: "+JSON.stringify(t)),r(t)}));t.video=e(t.video)}return n("chrome: "+JSON.stringify(t)),r(t)},r=function(e){return{name:{PermissionDeniedError:"NotAllowedError",ConstraintNotSatisfiedError:"OverconstrainedError"}[e.name]||e.name,message:e.message,constraint:e.constraintName,toString:function(){return this.name+(this.message&&": ")+this.message}}};navigator.getUserMedia=function(e,n,i){t(e,(function(e){navigator.webkitGetUserMedia(e,n,(function(e){i(r(e))}))}))};var i=function(e){return new Promise((function(t,r){navigator.getUserMedia(e,t,r)}))};if(navigator.mediaDevices||(navigator.mediaDevices={getUserMedia:i,enumerateDevices:function(){return new Promise((function(e){var t={audio:"audioinput",video:"videoinput"};return MediaStreamTrack.getSources((function(r){e(r.map((function(e){return{label:e.label,kind:t[e.kind],deviceId:e.id,groupId:""}})))}))}))}}),navigator.mediaDevices.getUserMedia){var o=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(e){return t(e,(function(e){return o(e).then((function(t){if(e.audio&&!t.getAudioTracks().length||e.video&&!t.getVideoTracks().length)throw t.getTracks().forEach((function(e){e.stop()})),new DOMException("","NotFoundError");return t}),(function(e){return Promise.reject(r(e))}))}))}}else navigator.mediaDevices.getUserMedia=function(e){return i(e)};void 0===navigator.mediaDevices.addEventListener&&(navigator.mediaDevices.addEventListener=function(){n("Dummy mediaDevices.addEventListener called.")}),void 0===navigator.mediaDevices.removeEventListener&&(navigator.mediaDevices.removeEventListener=function(){n("Dummy mediaDevices.removeEventListener called.")})}},{"../utils.js":10}],5:[function(e,t,r){"use strict";var n=e("sdp"),i=e("../utils").browserDetails,o={shimPeerConnection:function(){window.RTCIceGatherer&&(window.RTCIceCandidate||(window.RTCIceCandidate=function(e){return e}),window.RTCSessionDescription||(window.RTCSessionDescription=function(e){return e})),window.RTCPeerConnection=function(e){var t=this,r=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach((function(e){t[e]=r[e].bind(r)})),this.onicecandidate=null,this.onaddstream=null,this.ontrack=null,this.onremovestream=null,this.onsignalingstatechange=null,this.oniceconnectionstatechange=null,this.onnegotiationneeded=null,this.ondatachannel=null,this.localStreams=[],this.remoteStreams=[],this.getLocalStreams=function(){return t.localStreams},this.getRemoteStreams=function(){return t.remoteStreams},this.localDescription=new RTCSessionDescription({type:"",sdp:""}),this.remoteDescription=new RTCSessionDescription({type:"",sdp:""}),this.signalingState="stable",this.iceConnectionState="new",this.iceGatheringState="new",this.iceOptions={gatherPolicy:"all",iceServers:[]},e&&e.iceTransportPolicy)switch(e.iceTransportPolicy){case"all":case"relay":this.iceOptions.gatherPolicy=e.iceTransportPolicy;break;case"none":throw new TypeError('iceTransportPolicy "none" not supported')}if(this.usingBundle=e&&"max-bundle"===e.bundlePolicy,e&&e.iceServers){var n=JSON.parse(JSON.stringify(e.iceServers));this.iceOptions.iceServers=n.filter((function(e){if(e&&e.urls){var t=e.urls;return"string"==typeof t&&(t=[t]),!!(t=t.filter((function(e){return 0===e.indexOf("turn:")&&-1!==e.indexOf("transport=udp")&&-1===e.indexOf("turn:[")||0===e.indexOf("stun:")&&i.version>=14393}))[0])}return!1}))}this.transceivers=[],this._localIceCandidatesBuffer=[]},window.RTCPeerConnection.prototype._emitBufferedCandidates=function(){var e=this,t=n.splitSections(e.localDescription.sdp);this._localIceCandidatesBuffer.forEach((function(r){if(r.candidate&&0!==Object.keys(r.candidate).length)-1===r.candidate.candidate.indexOf("typ endOfCandidates")&&(t[r.candidate.sdpMLineIndex+1]+="a="+r.candidate.candidate+"\r\n");else for(var n=1;n<t.length;n++)-1===t[n].indexOf("\r\na=end-of-candidates\r\n")&&(t[n]+="a=end-of-candidates\r\n");e.localDescription.sdp=t.join(""),e.dispatchEvent(r),null!==e.onicecandidate&&e.onicecandidate(r),r.candidate||"complete"===e.iceGatheringState||e.transceivers.every((function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state}))&&(e.iceGatheringState="complete")})),this._localIceCandidatesBuffer=[]},window.RTCPeerConnection.prototype.addStream=function(e){this.localStreams.push(e.clone()),this._maybeFireNegotiationNeeded()},window.RTCPeerConnection.prototype.removeStream=function(e){var t=this.localStreams.indexOf(e);t>-1&&(this.localStreams.splice(t,1),this._maybeFireNegotiationNeeded())},window.RTCPeerConnection.prototype.getSenders=function(){return this.transceivers.filter((function(e){return!!e.rtpSender})).map((function(e){return e.rtpSender}))},window.RTCPeerConnection.prototype.getReceivers=function(){return this.transceivers.filter((function(e){return!!e.rtpReceiver})).map((function(e){return e.rtpReceiver}))},window.RTCPeerConnection.prototype._getCommonCapabilities=function(e,t){var r={codecs:[],headerExtensions:[],fecMechanisms:[]};return e.codecs.forEach((function(e){for(var n=0;n<t.codecs.length;n++){var i=t.codecs[n];if(e.name.toLowerCase()===i.name.toLowerCase()&&e.clockRate===i.clockRate&&e.numChannels===i.numChannels){r.codecs.push(i),i.rtcpFeedback=i.rtcpFeedback.filter((function(t){for(var r=0;r<e.rtcpFeedback.length;r++)if(e.rtcpFeedback[r].type===t.type&&e.rtcpFeedback[r].parameter===t.parameter)return!0;return!1}));break}}})),e.headerExtensions.forEach((function(e){for(var n=0;n<t.headerExtensions.length;n++){var i=t.headerExtensions[n];if(e.uri===i.uri){r.headerExtensions.push(i);break}}})),r},window.RTCPeerConnection.prototype._createIceAndDtlsTransports=function(e,t){var r=this,i=new RTCIceGatherer(r.iceOptions),o=new RTCIceTransport(i);i.onlocalcandidate=function(a){var s=new Event("icecandidate");s.candidate={sdpMid:e,sdpMLineIndex:t};var c=a.candidate,d=!c||0===Object.keys(c).length;d?(void 0===i.state&&(i.state="completed"),s.candidate.candidate="candidate:1 1 udp 1 0.0.0.0 9 typ endOfCandidates"):(c.component="RTCP"===o.component?2:1,s.candidate.candidate=n.writeCandidate(c));var u=n.splitSections(r.localDescription.sdp);-1===s.candidate.candidate.indexOf("typ endOfCandidates")?u[s.candidate.sdpMLineIndex+1]+="a="+s.candidate.candidate+"\r\n":u[s.candidate.sdpMLineIndex+1]+="a=end-of-candidates\r\n",r.localDescription.sdp=u.join("");var l=r.transceivers.every((function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state}));switch(r.iceGatheringState){case"new":r._localIceCandidatesBuffer.push(s),d&&l&&r._localIceCandidatesBuffer.push(new Event("icecandidate"));break;case"gathering":r._emitBufferedCandidates(),r.dispatchEvent(s),null!==r.onicecandidate&&r.onicecandidate(s),l&&(r.dispatchEvent(new Event("icecandidate")),null!==r.onicecandidate&&r.onicecandidate(new Event("icecandidate")),r.iceGatheringState="complete")}},o.onicestatechange=function(){r._updateConnectionState()};var a=new RTCDtlsTransport(o);return a.ondtlsstatechange=function(){r._updateConnectionState()},a.onerror=function(){a.state="failed",r._updateConnectionState()},{iceGatherer:i,iceTransport:o,dtlsTransport:a}},window.RTCPeerConnection.prototype._transceive=function(e,t,r){var i=this._getCommonCapabilities(e.localCapabilities,e.remoteCapabilities);t&&e.rtpSender&&(i.encodings=e.sendEncodingParameters,i.rtcp={cname:n.localCName},e.recvEncodingParameters.length&&(i.rtcp.ssrc=e.recvEncodingParameters[0].ssrc),e.rtpSender.send(i)),r&&e.rtpReceiver&&("video"===e.kind&&e.recvEncodingParameters&&e.recvEncodingParameters.forEach((function(e){delete e.rtx})),i.encodings=e.recvEncodingParameters,i.rtcp={cname:e.cname},e.sendEncodingParameters.length&&(i.rtcp.ssrc=e.sendEncodingParameters[0].ssrc),e.rtpReceiver.receive(i))},window.RTCPeerConnection.prototype.setLocalDescription=function(e){var t,r,i=this;if("offer"===e.type)this._pendingOffer&&(t=n.splitSections(e.sdp),r=t.shift(),t.forEach((function(e,t){var r=n.parseRtpParameters(e);i._pendingOffer[t].localCapabilities=r})),this.transceivers=this._pendingOffer,delete this._pendingOffer);else if("answer"===e.type){t=n.splitSections(i.remoteDescription.sdp),r=t.shift();var o=n.matchPrefix(r,"a=ice-lite").length>0;t.forEach((function(e,t){var a=i.transceivers[t],s=a.iceGatherer,c=a.iceTransport,d=a.dtlsTransport,u=a.localCapabilities,l=a.remoteCapabilities;if("0"!==e.split("\n",1)[0].split(" ",2)[1]&&!a.isDatachannel){var f=n.getIceParameters(e,r);if(o){var p=n.matchPrefix(e,"a=candidate:").map((function(e){return n.parseCandidate(e)})).filter((function(e){return"1"===e.component}));p.length&&c.setRemoteCandidates(p)}var v=n.getDtlsParameters(e,r);o&&(v.role="server"),i.usingBundle&&0!==t||(c.start(s,f,o?"controlling":"controlled"),d.start(v));var m=i._getCommonCapabilities(u,l);i._transceive(a,m.codecs.length>0,!1)}}))}switch(this.localDescription={type:e.type,sdp:e.sdp},e.type){case"offer":this._updateSignalingState("have-local-offer");break;case"answer":this._updateSignalingState("stable");break;default:throw new TypeError('unsupported type "'+e.type+'"')}var a=arguments.length>1&&"function"==typeof arguments[1];if(a){var s=arguments[1];window.setTimeout((function(){s(),"new"===i.iceGatheringState&&(i.iceGatheringState="gathering"),i._emitBufferedCandidates()}),0)}var c=Promise.resolve();return c.then((function(){a||("new"===i.iceGatheringState&&(i.iceGatheringState="gathering"),window.setTimeout(i._emitBufferedCandidates.bind(i),500))})),c},window.RTCPeerConnection.prototype.setRemoteDescription=function(e){var t=this,r=new MediaStream,i=[],o=n.splitSections(e.sdp),a=o.shift(),s=n.matchPrefix(a,"a=ice-lite").length>0;switch(this.usingBundle=n.matchPrefix(a,"a=group:BUNDLE ").length>0,o.forEach((function(o,c){var d=n.splitLines(o)[0].substr(2).split(" "),u=d[0],l="0"===d[1],f=n.getDirection(o,a),p=n.matchPrefix(o,"a=mid:");if(p=p.length?p[0].substr(6):n.generateIdentifier(),"application"!==u||"DTLS/SCTP"!==d[2]){var v,m,g,h,b,w,y,S,T,C,k,R,D,P=n.parseRtpParameters(o);l||(k=n.getIceParameters(o,a),(R=n.getDtlsParameters(o,a)).role="client"),S=n.parseRtpEncodingParameters(o);var E=n.matchPrefix(o,"a=ssrc:").map((function(e){return n.parseSsrcMedia(e)})).filter((function(e){return"cname"===e.attribute}))[0];E&&(D=E.value);var x=n.matchPrefix(o,"a=end-of-candidates",a).length>0,A=n.matchPrefix(o,"a=candidate:").map((function(e){return n.parseCandidate(e)})).filter((function(e){return"1"===e.component}));if("offer"!==e.type||l)"answer"!==e.type||l||(m=(v=t.transceivers[c]).iceGatherer,g=v.iceTransport,h=v.dtlsTransport,b=v.rtpSender,w=v.rtpReceiver,y=v.sendEncodingParameters,T=v.localCapabilities,t.transceivers[c].recvEncodingParameters=S,t.transceivers[c].remoteCapabilities=P,t.transceivers[c].cname=D,(s||x)&&A.length&&g.setRemoteCandidates(A),t.usingBundle&&0!==c||(g.start(m,k,"controlling"),h.start(R)),t._transceive(v,"sendrecv"===f||"recvonly"===f,"sendrecv"===f||"sendonly"===f),!w||"sendrecv"!==f&&"sendonly"!==f?delete v.rtpReceiver:(C=w.track,i.push([C,w]),r.addTrack(C)));else{var I,O=t.usingBundle&&c>0?{iceGatherer:t.transceivers[0].iceGatherer,iceTransport:t.transceivers[0].iceTransport,dtlsTransport:t.transceivers[0].dtlsTransport}:t._createIceAndDtlsTransports(p,c);x&&O.iceTransport.setRemoteCandidates(A),(T=RTCRtpReceiver.getCapabilities(u)).codecs=T.codecs.filter((function(e){return"rtx"!==e.name})),y=[{ssrc:1001*(2*c+2)}],C=(w=new RTCRtpReceiver(O.dtlsTransport,u)).track,i.push([C,w]),r.addTrack(C),t.localStreams.length>0&&t.localStreams[0].getTracks().length>=c&&("audio"===u?I=t.localStreams[0].getAudioTracks()[0]:"video"===u&&(I=t.localStreams[0].getVideoTracks()[0]),I&&(b=new RTCRtpSender(I,O.dtlsTransport))),t.transceivers[c]={iceGatherer:O.iceGatherer,iceTransport:O.iceTransport,dtlsTransport:O.dtlsTransport,localCapabilities:T,remoteCapabilities:P,rtpSender:b,rtpReceiver:w,kind:u,mid:p,cname:D,sendEncodingParameters:y,recvEncodingParameters:S},t._transceive(t.transceivers[c],!1,"sendrecv"===f||"sendonly"===f)}}else t.transceivers[c]={mid:p,isDatachannel:!0}})),this.remoteDescription={type:e.type,sdp:e.sdp},e.type){case"offer":this._updateSignalingState("have-remote-offer");break;case"answer":this._updateSignalingState("stable");break;default:throw new TypeError('unsupported type "'+e.type+'"')}return r.getTracks().length&&(t.remoteStreams.push(r),window.setTimeout((function(){var e=new Event("addstream");e.stream=r,t.dispatchEvent(e),null!==t.onaddstream&&window.setTimeout((function(){t.onaddstream(e)}),0),i.forEach((function(n){var i=n[0],o=n[1],a=new Event("track");a.track=i,a.receiver=o,a.streams=[r],t.dispatchEvent(e),null!==t.ontrack&&window.setTimeout((function(){t.ontrack(a)}),0)}))}),0)),arguments.length>1&&"function"==typeof arguments[1]&&window.setTimeout(arguments[1],0),Promise.resolve()},window.RTCPeerConnection.prototype.close=function(){this.transceivers.forEach((function(e){e.iceTransport&&e.iceTransport.stop(),e.dtlsTransport&&e.dtlsTransport.stop(),e.rtpSender&&e.rtpSender.stop(),e.rtpReceiver&&e.rtpReceiver.stop()})),this._updateSignalingState("closed")},window.RTCPeerConnection.prototype._updateSignalingState=function(e){this.signalingState=e;var t=new Event("signalingstatechange");this.dispatchEvent(t),null!==this.onsignalingstatechange&&this.onsignalingstatechange(t)},window.RTCPeerConnection.prototype._maybeFireNegotiationNeeded=function(){var e=new Event("negotiationneeded");this.dispatchEvent(e),null!==this.onnegotiationneeded&&this.onnegotiationneeded(e)},window.RTCPeerConnection.prototype._updateConnectionState=function(){var e,t={new:0,closed:0,connecting:0,checking:0,connected:0,completed:0,failed:0};if(this.transceivers.forEach((function(e){t[e.iceTransport.state]++,t[e.dtlsTransport.state]++})),t.connected+=t.completed,e="new",t.failed>0?e="failed":t.connecting>0||t.checking>0?e="connecting":t.disconnected>0?e="disconnected":t.new>0?e="new":(t.connected>0||t.completed>0)&&(e="connected"),e!==this.iceConnectionState){this.iceConnectionState=e;var r=new Event("iceconnectionstatechange");this.dispatchEvent(r),null!==this.oniceconnectionstatechange&&this.oniceconnectionstatechange(r)}},window.RTCPeerConnection.prototype.createOffer=function(){var e,t=this;if(this._pendingOffer)throw new Error("createOffer called while there is a pending offer.");1===arguments.length&&"function"!=typeof arguments[0]?e=arguments[0]:3===arguments.length&&(e=arguments[2]);var r=[],i=0,o=0;if(this.localStreams.length&&(i=this.localStreams[0].getAudioTracks().length,o=this.localStreams[0].getVideoTracks().length),e){if(e.mandatory||e.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==e.offerToReceiveAudio&&(i=e.offerToReceiveAudio),void 0!==e.offerToReceiveVideo&&(o=e.offerToReceiveVideo)}for(this.localStreams.length&&this.localStreams[0].getTracks().forEach((function(e){r.push({kind:e.kind,track:e,wantReceive:"audio"===e.kind?i>0:o>0}),"audio"===e.kind?i--:"video"===e.kind&&o--}));i>0||o>0;)i>0&&(r.push({kind:"audio",wantReceive:!0}),i--),o>0&&(r.push({kind:"video",wantReceive:!0}),o--);var a=n.writeSessionBoilerplate(),s=[];r.forEach((function(e,r){var i,o,a=e.track,c=e.kind,d=n.generateIdentifier(),u=t.usingBundle&&r>0?{iceGatherer:s[0].iceGatherer,iceTransport:s[0].iceTransport,dtlsTransport:s[0].dtlsTransport}:t._createIceAndDtlsTransports(d,r),l=RTCRtpSender.getCapabilities(c);l.codecs=l.codecs.filter((function(e){return"rtx"!==e.name}));var f=[{ssrc:1001*(2*r+1)}];a&&(i=new RTCRtpSender(a,u.dtlsTransport)),e.wantReceive&&(o=new RTCRtpReceiver(u.dtlsTransport,c)),s[r]={iceGatherer:u.iceGatherer,iceTransport:u.iceTransport,dtlsTransport:u.dtlsTransport,localCapabilities:l,remoteCapabilities:null,rtpSender:i,rtpReceiver:o,kind:c,mid:d,sendEncodingParameters:f,recvEncodingParameters:null}})),this.usingBundle&&(a+="a=group:BUNDLE "+s.map((function(e){return e.mid})).join(" ")+"\r\n"),r.forEach((function(e,r){var i=s[r];a+=n.writeMediaSection(i,i.localCapabilities,"offer",t.localStreams[0])})),this._pendingOffer=s;var c=new RTCSessionDescription({type:"offer",sdp:a});return arguments.length&&"function"==typeof arguments[0]&&window.setTimeout(arguments[0],0,c),Promise.resolve(c)},window.RTCPeerConnection.prototype.createAnswer=function(){var e=this,t=n.writeSessionBoilerplate();this.usingBundle&&(t+="a=group:BUNDLE "+this.transceivers.map((function(e){return e.mid})).join(" ")+"\r\n"),this.transceivers.forEach((function(r){if(r.isDatachannel)t+="m=application 0 DTLS/SCTP 5000\r\nc=IN IP4 0.0.0.0\r\na=mid:"+r.mid+"\r\n";else{var i=e._getCommonCapabilities(r.localCapabilities,r.remoteCapabilities);t+=n.writeMediaSection(r,i,"answer",e.localStreams[0])}}));var r=new RTCSessionDescription({type:"answer",sdp:t});return arguments.length&&"function"==typeof arguments[0]&&window.setTimeout(arguments[0],0,r),Promise.resolve(r)},window.RTCPeerConnection.prototype.addIceCandidate=function(e){if(null===e)this.transceivers.forEach((function(e){e.iceTransport.addRemoteCandidate({})}));else{var t=e.sdpMLineIndex;if(e.sdpMid)for(var r=0;r<this.transceivers.length;r++)if(this.transceivers[r].mid===e.sdpMid){t=r;break}var i=this.transceivers[t];if(i){var o=Object.keys(e.candidate).length>0?n.parseCandidate(e.candidate):{};if("tcp"===o.protocol&&(0===o.port||9===o.port))return;if("1"!==o.component)return;"endOfCandidates"===o.type&&(o={}),i.iceTransport.addRemoteCandidate(o);var a=n.splitSections(this.remoteDescription.sdp);a[t+1]+=(o.type?e.candidate.trim():"a=end-of-candidates")+"\r\n",this.remoteDescription.sdp=a.join("")}}return arguments.length>1&&"function"==typeof arguments[1]&&window.setTimeout(arguments[1],0),Promise.resolve()},window.RTCPeerConnection.prototype.getStats=function(){var e=[];this.transceivers.forEach((function(t){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach((function(r){t[r]&&e.push(t[r].getStats())}))}));var t=arguments.length>1&&"function"==typeof arguments[1]&&arguments[1];return new Promise((function(r){var n=new Map;Promise.all(e).then((function(e){e.forEach((function(e){Object.keys(e).forEach((function(t){n.set(t,e[t]),n[t]=e[t]}))})),t&&window.setTimeout(t,0,n),r(n)}))}))}}};t.exports={shimPeerConnection:o.shimPeerConnection,shimGetUserMedia:e("./getusermedia")}},{"../utils":10,"./getusermedia":6,sdp:1}],6:[function(e,t,r){"use strict";t.exports=function(){var e=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(t){return e(t).catch((function(e){return Promise.reject(function(e){return{name:{PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:e.message,constraint:e.constraint,toString:function(){return this.name}}}(e))}))}}},{}],7:[function(e,t,r){"use strict";var n=e("../utils").browserDetails,i={shimOnTrack:function(){"object"==typeof window&&window.RTCPeerConnection&&!("ontrack"in window.RTCPeerConnection.prototype)&&Object.defineProperty(window.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(e){this._ontrack&&(this.removeEventListener("track",this._ontrack),this.removeEventListener("addstream",this._ontrackpoly)),this.addEventListener("track",this._ontrack=e),this.addEventListener("addstream",this._ontrackpoly=function(e){e.stream.getTracks().forEach(function(t){var r=new Event("track");r.track=t,r.receiver={track:t},r.streams=[e.stream],this.dispatchEvent(r)}.bind(this))}.bind(this))}})},shimSourceObject:function(){"object"==typeof window&&window.HTMLMediaElement&&!("srcObject"in window.HTMLMediaElement.prototype)&&Object.defineProperty(window.HTMLMediaElement.prototype,"srcObject",{get:function(){return this.mozSrcObject},set:function(e){this.mozSrcObject=e}})},shimPeerConnection:function(){if("object"==typeof window&&(window.RTCPeerConnection||window.mozRTCPeerConnection)){window.RTCPeerConnection||(window.RTCPeerConnection=function(e,t){if(n.version<38&&e&&e.iceServers){for(var r=[],i=0;i<e.iceServers.length;i++){var o=e.iceServers[i];if(o.hasOwnProperty("urls"))for(var a=0;a<o.urls.length;a++){var s={url:o.urls[a]};0===o.urls[a].indexOf("turn")&&(s.username=o.username,s.credential=o.credential),r.push(s)}else r.push(e.iceServers[i])}e.iceServers=r}return new mozRTCPeerConnection(e,t)},window.RTCPeerConnection.prototype=mozRTCPeerConnection.prototype,mozRTCPeerConnection.generateCertificate&&Object.defineProperty(window.RTCPeerConnection,"generateCertificate",{get:function(){return mozRTCPeerConnection.generateCertificate}}),window.RTCSessionDescription=mozRTCSessionDescription,window.RTCIceCandidate=mozRTCIceCandidate),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(e){var t=RTCPeerConnection.prototype[e];RTCPeerConnection.prototype[e]=function(){return arguments[0]=new("addIceCandidate"===e?RTCIceCandidate:RTCSessionDescription)(arguments[0]),t.apply(this,arguments)}}));var e=RTCPeerConnection.prototype.addIceCandidate;RTCPeerConnection.prototype.addIceCandidate=function(){return null===arguments[0]?Promise.resolve():e.apply(this,arguments)};var t=RTCPeerConnection.prototype.getStats;RTCPeerConnection.prototype.getStats=function(e,r,n){return t.apply(this,[e||null]).then((function(e){return function(e){var t=new Map;return Object.keys(e).forEach((function(r){t.set(r,e[r]),t[r]=e[r]})),t}(e)})).then(r,n)}}}};t.exports={shimOnTrack:i.shimOnTrack,shimSourceObject:i.shimSourceObject,shimPeerConnection:i.shimPeerConnection,shimGetUserMedia:e("./getusermedia")}},{"../utils":10,"./getusermedia":8}],8:[function(e,t,r){"use strict";var n=e("../utils").log,i=e("../utils").browserDetails;t.exports=function(){var e=function(e){return{name:{SecurityError:"NotAllowedError",PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:{"The operation is insecure.":"The request is not allowed by the user agent or the platform in the current context."}[e.message]||e.message,constraint:e.constraint,toString:function(){return this.name+(this.message&&": ")+this.message}}},t=function(t,r,o){var a=function(e){if("object"!=typeof e||e.require)return e;var t=[];return Object.keys(e).forEach((function(r){if("require"!==r&&"advanced"!==r&&"mediaSource"!==r){var n=e[r]="object"==typeof e[r]?e[r]:{ideal:e[r]};if(void 0===n.min&&void 0===n.max&&void 0===n.exact||t.push(r),void 0!==n.exact&&("number"==typeof n.exact?n.min=n.max=n.exact:e[r]=n.exact,delete n.exact),void 0!==n.ideal){e.advanced=e.advanced||[];var i={};"number"==typeof n.ideal?i[r]={min:n.ideal,max:n.ideal}:i[r]=n.ideal,e.advanced.push(i),delete n.ideal,Object.keys(n).length||delete e[r]}}})),t.length&&(e.require=t),e};return t=JSON.parse(JSON.stringify(t)),i.version<38&&(n("spec: "+JSON.stringify(t)),t.audio&&(t.audio=a(t.audio)),t.video&&(t.video=a(t.video)),n("ff37: "+JSON.stringify(t))),navigator.mozGetUserMedia(t,r,(function(t){o(e(t))}))};if(navigator.mediaDevices||(navigator.mediaDevices={getUserMedia:function(e){return new Promise((function(r,n){t(e,r,n)}))},addEventListener:function(){},removeEventListener:function(){}}),navigator.mediaDevices.enumerateDevices=navigator.mediaDevices.enumerateDevices||function(){return new Promise((function(e){e([{kind:"audioinput",deviceId:"default",label:"",groupId:""},{kind:"videoinput",deviceId:"default",label:"",groupId:""}])}))},i.version<41){var r=navigator.mediaDevices.enumerateDevices.bind(navigator.mediaDevices);navigator.mediaDevices.enumerateDevices=function(){return r().then(void 0,(function(e){if("NotFoundError"===e.name)return[];throw e}))}}if(i.version<49){var o=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(t){return o(t).then((function(e){if(t.audio&&!e.getAudioTracks().length||t.video&&!e.getVideoTracks().length)throw e.getTracks().forEach((function(e){e.stop()})),new DOMException("The object can not be found here.","NotFoundError");return e}),(function(t){return Promise.reject(e(t))}))}}navigator.getUserMedia=function(e,r,n){if(i.version<44)return t(e,r,n);console.warn("navigator.getUserMedia has been replaced by navigator.mediaDevices.getUserMedia"),navigator.mediaDevices.getUserMedia(e).then(r,n)}}},{"../utils":10}],9:[function(e,t,r){"use strict";var n={shimGetUserMedia:function(){navigator.getUserMedia=navigator.webkitGetUserMedia}};t.exports={shimGetUserMedia:n.shimGetUserMedia}},{}],10:[function(e,t,r){"use strict";var n=!0,i={disableLog:function(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(n=e,e?"adapter.js logging disabled":"adapter.js logging enabled")},log:function(){if("object"==typeof window){if(n)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}},extractVersion:function(e,t,r){var n=e.match(t);return n&&n.length>=r&&parseInt(n[r],10)},detectBrowser:function(){var e={browser:null,version:null};if("undefined"==typeof window||!window.navigator)return e.browser="Not a browser.",e;if(navigator.mozGetUserMedia)e.browser="firefox",e.version=this.extractVersion(navigator.userAgent,/Firefox\/([0-9]+)\./,1);else if(navigator.webkitGetUserMedia)if(window.webkitRTCPeerConnection)e.browser="chrome",e.version=this.extractVersion(navigator.userAgent,/Chrom(e|ium)\/([0-9]+)\./,2);else{if(!navigator.userAgent.match(/Version\/(\d+).(\d+)/))return e.browser="Unsupported webkit-based browser with GUM support but no WebRTC support.",e;e.browser="safari",e.version=this.extractVersion(navigator.userAgent,/AppleWebKit\/([0-9]+)\./,1)}else{if(!navigator.mediaDevices||!navigator.userAgent.match(/Edge\/(\d+).(\d+)$/))return e.browser="Not a supported browser.",e;e.browser="edge",e.version=this.extractVersion(navigator.userAgent,/Edge\/(\d+).(\d+)$/,2)}return e}};t.exports={log:i.log,disableLog:i.disableLog,browserDetails:i.detectBrowser(),extractVersion:i.extractVersion}},{}]},{},[2])(2)},508:function(t){"use strict";t.exports=e}},r={};function n(e){var i=r[e];if(void 0!==i)return i.exports;var o=r[e]={id:e,exports:{}};return t[e](o,o.exports,n),o.exports}n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,{a:t}),t},n.d=function(e,t){for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var i={};return function(){"use strict";n.r(i),n.d(i,{PhoneButton:function(){return y},PhoneWidget:function(){return T}});var e=n(508);const t={key:0,class:"phone-widget"},r={ref:"sipAudioElement",autoplay:"",playsinline:"",loop:"",style:{display:"block"}};var o=n(900),a=n.n(o);c.sessions={},c.isExtensionEnabled=function(){if(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia)return!0;if(window.navigator.userAgent.match("Chrome")){var e=parseInt(window.navigator.userAgent.match(/Chrome\/(.*) /)[1],10),t=33;return window.navigator.userAgent.match("Linux")&&(t=35),e>=26&&e<=t||c.extension.isInstalled()}return!0};var s={extensionId:"hapfgfdkleiggjjpfpenajgdnfckjpaj",isInstalled:function(){return null!==document.querySelector("#janus-extension-installed")},getScreen:function(e){var t=window.setTimeout((function(){var t=new Error("NavigatorUserMediaError");return t.name='The required Chrome extension is not installed: click <a href="#">here</a> to install it. (NOTE: this will need you to refresh the page)',e(t)}),1e3);this.cache[t]=e,window.postMessage({type:"janusGetScreen",id:t},"*")},init:function(){var e={};this.cache=e,window.addEventListener("message",(function(t){if(t.origin==window.location.origin)if("janusGotScreen"==t.data.type&&e[t.data.id]){var r=e[t.data.id];if(delete e[t.data.id],""===t.data.sourceId){var n=new Error("NavigatorUserMediaError");n.name="You cancelled the request for permission, giving up...",r(n)}else r(null,t.data.sourceId)}else"janusGetScreenPending"==t.data.type&&(console.log("clearing ",t.data.id),window.clearTimeout(t.data.id))}))}};function c(e){if((e=e||{}).success="function"==typeof e.success?e.success:c.noop,e.error="function"==typeof e.error?e.error:c.noop,e.destroyed="function"==typeof e.destroyed?e.destroyed:c.noop,!c.initDone)return e.error("Library not initialized"),{};if(!c.isWebrtcSupported())return e.error("WebRTC not supported by this browser"),{};if(c.log("Library initialized: "+c.initDone),!e.server)return e.error("Invalid server url"),{};var t=!1,r=null,n={},i=null,o=null,a=0,s=e.server;c.isArray(s)?(c.log("Multiple servers provided ("+s.length+"), will use the first that works"),s=null,o=e.server,c.debug(o)):0===s.indexOf("ws")?(t=!0,c.log("Using WebSockets to contact Janus: "+s)):(t=!1,c.log("Using REST API to contact Janus: "+s));var d=e.iceServers||[{urls:"stun:stun.l.google.com:19302"}],u=e.iceTransportPolicy,l=e.bundlePolicy,f=!0===e.ipv6,p=!1;void 0!==e.withCredentials&&null!==e.withCredentials&&(p=!0===e.withCredentials);var v=10;void 0!==e.max_poll_events&&null!==e.max_poll_events&&(v=e.max_poll_events),v<1&&(v=1);var m=null;void 0!==e.token&&null!==e.token&&(m=e.token);var g=null;void 0!==e.apisecret&&null!==e.apisecret&&(g=e.apisecret),this.destroyOnUnload=!0,void 0!==e.destroyOnUnload&&null!==e.destroyOnUnload&&(this.destroyOnUnload=!0===e.destroyOnUnload);var h=25e3;void 0!==e.keepAlivePeriod&&null!==e.keepAlivePeriod&&(h=e.keepAlivePeriod),isNaN(h)&&(h=25e3);var b=6e4;function w(e){var t={high:9e5,medium:3e5,low:1e5};return null!=e&&(e.high&&(t.high=e.high),e.medium&&(t.medium=e.medium),e.low&&(t.low=e.low)),t}void 0!==e.longPollTimeout&&null!==e.longPollTimeout&&(b=e.longPollTimeout),isNaN(b)&&(b=6e4);var y=!1,S=null,T={},C=this,k=0,R={};function D(){if(null!=S)if(c.debug("Long poll..."),y){var t=s+"/"+S+"?rid="+(new Date).getTime();v&&(t=t+"&maxev="+v),m&&(t=t+"&token="+encodeURIComponent(m)),g&&(t=t+"&apisecret="+encodeURIComponent(g)),c.httpAPICall(t,{verb:"GET",withCredentials:p,success:P,timeout:b,error:function(t,r){if(c.error(t+":",r),++k>3)return y=!1,void e.error("Lost connection to the server (is it down?)");D()}})}else c.warn("Is the server down? (connected=false)")}function P(e,n){if(k=0,t||null==S||!0===n||D(),t||!c.isArray(e))if("keepalive"!==e.janus)if("server_info"!==e.janus)if("ack"!==e.janus)if("success"!==e.janus)if("trickle"===e.janus){if(!(d=e.sender))return void c.warn("Missing sender...");if(!(l=T[d]))return void c.debug("This handle is not attached to this session");var i=e.candidate;c.debug("Got a trickled candidate on session "+S),c.debug(i);var o=l.webrtcStuff;o.pc&&o.remoteSdp?(c.debug("Adding remote candidate:",i),i&&!0!==i.completed?o.pc.addIceCandidate(i):o.pc.addIceCandidate(c.endOfCandidates)):(c.debug("We didn't do setRemoteDescription (trickle got here before the offer?), caching candidate"),o.candidates||(o.candidates=[]),o.candidates.push(i),c.debug(o.candidates))}else{if("webrtcup"===e.janus)return c.debug("Got a webrtcup event on session "+S),c.debug(e),(d=e.sender)?(l=T[d])?void l.webrtcState(!0):void c.debug("This handle is not attached to this session"):void c.warn("Missing sender...");if("hangup"===e.janus){if(c.debug("Got a hangup event on session "+S),c.debug(e),!(d=e.sender))return void c.warn("Missing sender...");if(!(l=T[d]))return void c.debug("This handle is not attached to this session");l.webrtcState(!1,e.reason),l.hangup()}else if("detached"===e.janus){if(c.debug("Got a detached event on session "+S),c.debug(e),!(d=e.sender))return void c.warn("Missing sender...");if(!(l=T[d]))return;l.detached=!0,l.ondetached(),l.detach()}else if("media"===e.janus){if(c.debug("Got a media event on session "+S),c.debug(e),!(d=e.sender))return void c.warn("Missing sender...");if(!(l=T[d]))return void c.debug("This handle is not attached to this session");l.mediaState(e.type,e.receiving)}else if("slowlink"===e.janus){if(c.debug("Got a slowlink event on session "+S),c.debug(e),!(d=e.sender))return void c.warn("Missing sender...");if(!(l=T[d]))return void c.debug("This handle is not attached to this session");l.slowLink(e.uplink,e.lost)}else{var a,s;if("error"===e.janus)return c.error("Ooops: "+e.error.code+" "+e.error.reason),c.debug(e),void((a=e.transaction)&&((s=R[a])&&s(e),delete R[a]));if("event"===e.janus){var d;if(c.debug("Got a plugin event on session "+S),c.debug(e),!(d=e.sender))return void c.warn("Missing sender...");var u=e.plugindata;if(!u)return void c.warn("Missing plugindata...");c.debug("  -- Event is coming from "+d+" ("+u.plugin+")");var l,f=u.data;if(c.debug(f),!(l=T[d]))return void c.warn("This handle is not attached to this session");var p=e.jsep;p&&(c.debug("Handling SDP as well..."),c.debug(p));var v=l.onmessage;v?(c.debug("Notifying application..."),v(f,p,e)):c.debug("No provided notification callback")}else{if("timeout"===e.janus)return c.error("Timeout on session "+S),c.debug(e),void(t&&r.close(3504,"Gateway timeout"));c.warn("Unknown message/event  '"+e.janus+"' on session "+S),c.debug(e)}}}else c.debug("Got a success on session "+S),c.debug(e),(a=e.transaction)&&((s=R[a])&&s(e),delete R[a]);else c.debug("Got an ack on session "+S),c.debug(e),(a=e.transaction)&&((s=R[a])&&s(e),delete R[a]);else c.debug("Got info on the Janus instance"),c.debug(e),(a=e.transaction)&&((s=R[a])&&s(e),delete R[a]);else c.debug("Got a keepalive on session "+S);else for(var m=0;m<e.length;m++)P(e[m],!0)}function E(){if(s&&t&&y){i=setTimeout(E,h);var e={janus:"keepalive",session_id:S,transaction:c.randomString(12)};m&&(e.token=m),g&&(e.apisecret=g),r.send(JSON.stringify(e))}}function x(d){var u=c.randomString(12),l={janus:"create",transaction:u};if(d.reconnect&&(y=!1,l.janus="claim",l.session_id=S,r&&(r.onopen=null,r.onerror=null,r.onclose=null,i&&(clearTimeout(i),i=null))),m&&(l.token=m),g&&(l.apisecret=g),!s&&c.isArray(o)&&(0===(s=o[a]).indexOf("ws")?(t=!0,c.log("Server #"+(a+1)+": trying WebSockets to contact Janus ("+s+")")):(t=!1,c.log("Server #"+(a+1)+": trying REST API to contact Janus ("+s+")"))),t)for(var f in r=c.newWebSocket(s,"janus-protocol"),n={error:function(){if(c.error("Error connecting to the Janus WebSockets server... "+s),c.isArray(o)&&!d.reconnect)return++a===o.length?void d.error("Error connecting to any of the provided Janus servers: Is the server down?"):(s=null,void setTimeout((function(){x(d)}),200));d.error("Error connecting to the Janus WebSockets server: Is the server down?")},open:function(){R[u]=function(e){if(c.debug(e),"success"!==e.janus)return c.error("Ooops: "+e.error.code+" "+e.error.reason),void d.error(e.error.reason);i=setTimeout(E,h),y=!0,S=e.session_id?e.session_id:e.data.id,d.reconnect?c.log("Claimed session: "+S):c.log("Created session: "+S),c.sessions[S]=C,d.success()},r.send(JSON.stringify(l))},message:function(e){P(JSON.parse(e.data))},close:function(){s&&y&&(y=!1,e.error("Lost connection to the server (is it down?)"))}})r.addEventListener(f,n[f]);else c.httpAPICall(s,{verb:"POST",withCredentials:p,body:l,success:function(e){if(c.debug(e),"success"!==e.janus)return c.error("Ooops: "+e.error.code+" "+e.error.reason),void d.error(e.error.reason);y=!0,S=e.session_id?e.session_id:e.data.id,d.reconnect?c.log("Claimed session: "+S):c.log("Created session: "+S),c.sessions[S]=C,D(),d.success()},error:function(e,t){if(c.error(e+":",t),c.isArray(o)&&!d.reconnect)return++a===o.length?void d.error("Error connecting to any of the provided Janus servers: Is the server down?"):(s=null,void setTimeout((function(){x(d)}),200));""===t?d.error(e+": Is the server down?"):d.error(e+": "+t)}})}function A(e,n){if((n=n||{}).success="function"==typeof n.success?n.success:c.noop,n.error="function"==typeof n.error?n.error:c.noop,!y)return console.warn("Is the server down? (connected=false)"),void n.error("Is the server down? (connected=false)");var i=T[e];if(!i||!i.webrtcStuff)return console.warn("Invalid handle"),void n.error("Invalid handle");var o=n.message,a=n.jsep,d=c.randomString(12),u={janus:"message",body:o,transaction:d};if(i.token&&(u.token=i.token),g&&(u.apisecret=g),a&&(u.jsep={type:a.type,sdp:a.sdp},a.e2ee&&(u.jsep.e2ee=!0),"hml"!==a.rid_order&&"lmh"!==a.rid_order||(u.jsep.rid_order=a.rid_order)),t)return u.session_id=S,u.handle_id=e,R[d]=function(e){if("success"!==e.janus)"ack"===e.janus?n.success():e.error?(console.error("Ooops: "+e.error.code+" "+e.error.reason),n.error(e.error.code+" "+e.error.reason)):(console.error("Unknown error"),n.error("Unknown error"));else{var t=e.plugindata;if(!t)return console.warn("Request succeeded, but missing plugindata..."),void n.success();var r=t.data;n.success(r)}},void r.send(JSON.stringify(u));c.httpAPICall(s+"/"+S+"/"+e,{verb:"POST",withCredentials:p,body:u,success:function(e){if("success"!==e.janus)"ack"===e.janus?n.success():e.error?(console.error("Ooops: "+e.error.code+" "+e.error.reason),n.error(e.error.code+" "+e.error.reason)):(console.error("Unknown error"),n.error("Unknown error"));else{var t=e.plugindata;if(!t)return console.warn("Request succeeded, but missing plugindata..."),void n.success();var r=t.data;n.success(r)}},error:function(e,t){console.error(e+":",t),n.error(e+": "+t)}})}function I(e,n){if(y){var i=T[e];if(i&&i.webrtcStuff){var o={janus:"trickle",candidate:n,transaction:c.randomString(12)};if(i.token&&(o.token=i.token),g&&(o.apisecret=g),c.vdebug("Sending trickle candidate (handle="+e+"):"),c.vdebug(o),t)return o.session_id=S,o.handle_id=e,void r.send(JSON.stringify(o));c.httpAPICall(s+"/"+S+"/"+e,{verb:"POST",withCredentials:p,body:o,success:function(e){c.vdebug("Candidate sent!"),c.vdebug(e),"ack"===e.janus||c.error("Ooops: "+e.error.code+" "+e.error.reason)},error:function(e,t){c.error(e+":",t)}})}else c.warn("Invalid handle")}else c.warn("Is the server down? (connected=false)")}function O(e,t,r,n,i){var o=T[e];if(o&&o.webrtcStuff){var a=o.webrtcStuff;if(a.pc){var s=function(e){c.log("Received state change on data channel:",e);var t=e.target.label,r=e.target.protocol,n=a.dataChannel[t]?a.dataChannel[t].readyState:"null";if(c.log("State change on <"+t+"> data channel: "+n),"open"===n){if(a.dataChannel[t].pending&&a.dataChannel[t].pending.length>0){for(var i of(c.log("Sending pending messages on <"+t+">:",a.dataChannel[t].pending.length),a.dataChannel[t].pending))c.log("Sending data on data channel <"+t+">"),c.debug(i),a.dataChannel[t].send(i);a.dataChannel[t].pending=[]}o.ondataopen(t,r)}};if(n)a.dataChannel[t]=n;else{var d={ordered:!0};r&&(d.protocol=r),a.dataChannel[t]=a.pc.createDataChannel(t,d)}a.dataChannel[t].onmessage=function(e){c.log("Received message on data channel:",e);var t=e.target.label;o.ondata(e.data,t)},a.dataChannel[t].onopen=s,a.dataChannel[t].onclose=s,a.dataChannel[t].onerror=function(e){c.error("Got error on data channel:",e)},a.dataChannel[t].pending=[],i&&a.dataChannel[t].pending.push(i)}else c.warn("Invalid PeerConnection")}else c.warn("Invalid handle")}function M(e,t){(t=t||{}).success="function"==typeof t.success?t.success:c.noop,t.error="function"==typeof t.error?t.error:c.noop;var r=T[e];if(!r||!r.webrtcStuff)return c.warn("Invalid handle"),void t.error("Invalid handle");var n=r.webrtcStuff,i=t.text||t.data;if(!i)return c.warn("Invalid data"),void t.error("Invalid data");var o=t.label?t.label:c.dataChanDefaultLabel;return n.dataChannel[o]?"open"!==n.dataChannel[o].readyState?(n.dataChannel[o].pending.push(i),void t.success()):(c.log("Sending data on data channel <"+o+">"),c.debug(i),n.dataChannel[o].send(i),void t.success()):(O(e,o,t.protocol,!1,i,t.protocol),void t.success())}function j(e,t){(t=t||{}).success="function"==typeof t.success?t.success:c.noop,t.error="function"==typeof t.error?t.error:c.noop;var r=T[e];if(!r||!r.webrtcStuff)return c.warn("Invalid handle"),void t.error("Invalid handle");var n=r.webrtcStuff;if(!n.dtmfSender){if(n.pc){var i=n.pc.getSenders().find((function(e){return e.track&&"audio"===e.track.kind}));if(!i)return c.warn("Invalid DTMF configuration (no audio track)"),void t.error("Invalid DTMF configuration (no audio track)");n.dtmfSender=i.dtmf,n.dtmfSender&&(c.log("Created DTMF Sender"),n.dtmfSender.ontonechange=function(e){c.debug("Sent DTMF tone: "+e.tone)})}if(!n.dtmfSender)return c.warn("Invalid DTMF configuration"),void t.error("Invalid DTMF configuration")}var o=t.dtmf;if(!o)return c.warn("Invalid DTMF parameters"),void t.error("Invalid DTMF parameters");var a=o.tones;if(!a)return c.warn("Invalid DTMF string"),void t.error("Invalid DTMF string");var s="number"==typeof o.duration?o.duration:500,d="number"==typeof o.gap?o.gap:50;c.debug("Sending DTMF string "+a+" (duration "+s+"ms, gap "+d+"ms)"),n.dtmfSender.insertDTMF(a,s,d),t.success()}function L(e,n){(n=n||{}).success="function"==typeof n.success?n.success:c.noop,n.error="function"==typeof n.error?n.error:c.noop;var i=!0===n.noRequest;c.log("Destroying handle "+e+" (only-locally="+i+")"),q(e);var o=T[e];if(!o||o.detached)return delete T[e],void n.success();if(i)return delete T[e],void n.success();if(!y)return c.warn("Is the server down? (connected=false)"),void n.error("Is the server down? (connected=false)");var a={janus:"detach",transaction:c.randomString(12)};if(o.token&&(a.token=o.token),g&&(a.apisecret=g),t)return a.session_id=S,a.handle_id=e,r.send(JSON.stringify(a)),delete T[e],void n.success();c.httpAPICall(s+"/"+S+"/"+e,{verb:"POST",withCredentials:p,body:a,success:function(t){c.log("Destroyed handle:"),c.debug(t),"success"!==t.janus&&c.error("Ooops: "+t.error.code+" "+t.error.reason),delete T[e],n.success()},error:function(t,r){c.error(t+":",r),delete T[e],n.success()}})}function V(e,t,r,n,i){var o=T[e];if(!o||!o.webrtcStuff)return c.warn("Invalid handle"),n.stream||c.stopAllTracks(i),void n.error("Invalid handle");var a=o.webrtcStuff;c.debug("streamsDone:",i),i&&(c.debug("  -- Audio tracks:",i.getAudioTracks()),c.debug("  -- Video tracks:",i.getVideoTracks()));var s=!1;if(a.myStream&&r.update&&!a.streamExternal){if((!r.update&&W(r)||r.update&&(r.addAudio||r.replaceAudio))&&i.getAudioTracks()&&i.getAudioTracks().length)if(a.myStream.addTrack(i.getAudioTracks()[0]),c.unifiedPlan){c.log((r.replaceAudio?"Replacing":"Adding")+" audio track:",i.getAudioTracks()[0]);var p=null;if((m=a.pc.getTransceivers())&&m.length>0)for(var v of m)if(v.sender&&v.sender.track&&"audio"===v.sender.track.kind||v.receiver&&v.receiver.track&&"audio"===v.receiver.track.kind){p=v;break}p&&p.sender?p.sender.replaceTrack(i.getAudioTracks()[0]):a.pc.addTrack(i.getAudioTracks()[0],i)}else c.log((r.replaceAudio?"Replacing":"Adding")+" audio track:",i.getAudioTracks()[0]),a.pc.addTrack(i.getAudioTracks()[0],i);if((!r.update&&H(r)||r.update&&(r.addVideo||r.replaceVideo))&&i.getVideoTracks()&&i.getVideoTracks().length)if(a.myStream.addTrack(i.getVideoTracks()[0]),c.unifiedPlan){c.log((r.replaceVideo?"Replacing":"Adding")+" video track:",i.getVideoTracks()[0]);var m,g=null;if((m=a.pc.getTransceivers())&&m.length>0)for(var v of m)if(v.sender&&v.sender.track&&"video"===v.sender.track.kind||v.receiver&&v.receiver.track&&"video"===v.receiver.track.kind){g=v;break}g&&g.sender?g.sender.replaceTrack(i.getVideoTracks()[0]):a.pc.addTrack(i.getVideoTracks()[0],i)}else c.log((r.replaceVideo?"Replacing":"Adding")+" video track:",i.getVideoTracks()[0]),a.pc.addTrack(i.getVideoTracks()[0],i)}else a.myStream=i,s=!0;if(!a.pc){var h={iceServers:d,iceTransportPolicy:u,bundlePolicy:l};"chrome"===c.webRTCAdapter.browserDetails.browser&&(h.sdpSemantics=c.webRTCAdapter.browserDetails.version<72?"plan-b":"unified-plan");var b={optional:[{DtlsSrtpKeyAgreement:!0}]};if(f&&b.optional.push({googIPv6:!0}),n.rtcConstraints&&"object"==typeof n.rtcConstraints)for(var y in c.debug("Adding custom PeerConnection constraints:",n.rtcConstraints),n.rtcConstraints)b.optional.push(n.rtcConstraints[y]);"edge"===c.webRTCAdapter.browserDetails.browser&&(h.bundlePolicy="max-bundle"),RTCRtpSender&&(RTCRtpSender.prototype.createEncodedStreams||RTCRtpSender.prototype.createEncodedAudioStreams&&RTCRtpSender.prototype.createEncodedVideoStreams)&&(n.senderTransforms||n.receiverTransforms)&&(a.senderTransforms=n.senderTransforms,a.receiverTransforms=n.receiverTransforms,h.forceEncodedAudioInsertableStreams=!0,h.forceEncodedVideoInsertableStreams=!0,h.encodedInsertableStreams=!0),c.log("Creating PeerConnection"),c.debug(b),a.pc=new RTCPeerConnection(h,b),c.debug(a.pc),a.pc.getStats&&(a.volume={},a.bitrate.value="0 kbits/sec"),c.log("Preparing local SDP and gathering candidates (trickle="+a.trickle+")"),a.pc.oniceconnectionstatechange=function(e){a.pc&&o.iceState(a.pc.iceConnectionState)},a.pc.onicecandidate=function(t){if(!t.candidate||"edge"===c.webRTCAdapter.browserDetails.browser&&t.candidate.candidate.indexOf("endOfCandidates")>0)c.log("End of candidates."),a.iceDone=!0,!0===a.trickle?I(e,{completed:!0}):function(e,t){(t=t||{}).success="function"==typeof t.success?t.success:c.noop,t.error="function"==typeof t.error?t.error:c.noop;var r=T[e];if(r&&r.webrtcStuff){var n=r.webrtcStuff;c.log("Sending offer/answer SDP..."),n.mySdp?(n.mySdp={type:n.pc.localDescription.type,sdp:n.pc.localDescription.sdp},!1===n.trickle&&(n.mySdp.trickle=!1),c.debug(t),n.sdpSent=!0,t.success(n.mySdp)):c.warn("Local SDP instance is invalid, not sending anything...")}else c.warn("Invalid handle, not sending anything")}(e,n);else{var r={candidate:t.candidate.candidate,sdpMid:t.candidate.sdpMid,sdpMLineIndex:t.candidate.sdpMLineIndex};!0===a.trickle&&I(e,r)}},a.pc.ontrack=function(e){if(c.log("Handling Remote Track"),c.debug(e),e.streams&&(a.remoteStream=e.streams[0],o.onremotestream(a.remoteStream),!e.track.onended)){if(a.receiverTransforms){var t=null;RTCRtpSender.prototype.createEncodedStreams?t=e.receiver.createEncodedStreams():(RTCRtpSender.prototype.createAudioEncodedStreams||RTCRtpSender.prototype.createEncodedVideoStreams)&&("audio"===e.track.kind&&a.receiverTransforms.audio?t=e.receiver.createEncodedAudioStreams():"video"===e.track.kind&&a.receiverTransforms.video&&(t=e.receiver.createEncodedVideoStreams())),t&&(t.readableStream&&t.writableStream?t.readableStream.pipeThrough(a.receiverTransforms[e.track.kind]).pipeTo(t.writableStream):t.readable&&t.writable&&t.readable.pipeThrough(a.receiverTransforms[e.track.kind]).pipeTo(t.writable))}var r=null;c.log("Adding onended callback to track:",e.track),e.track.onended=function(e){c.log("Remote track removed:",e),a.remoteStream&&(clearTimeout(r),a.remoteStream.removeTrack(e.target),o.onremotestream(a.remoteStream))},e.track.onmute=function(e){c.log("Remote track muted:",e),a.remoteStream&&null==r&&(r=setTimeout((function(){c.log("Removing remote track"),a.remoteStream&&(a.remoteStream.removeTrack(e.target),o.onremotestream(a.remoteStream)),r=null}),2520))},e.track.onunmute=function(e){if(c.log("Remote track flowing again:",e),null!=r)clearTimeout(r),r=null;else try{let t=a.pc?a.pc.getTransceivers():null,r=t?t.find((t=>t.receiver.track===e.target)):null,n=r?r.mid:e.target.id;o.onremotetrack(e.target,n,!0,{reason:"unmute"})}catch(e){c.error("Error calling onremotetrack on unmute",e)}}}}}if(s&&i){c.log("Adding local stream");var S=!0===n.simulcast2;i.getTracks().forEach((function(e){c.log("Adding local track:",e);var t=null;if(S&&"audio"!==e.kind){c.log("Enabling rid-based simulcasting:",e);var r=w(n.simulcastMaxBitrates),o=a.pc.addTransceiver(e,{direction:"sendrecv",streams:[i],sendEncodings:n.sendEncodings||[{rid:"h",active:!0,maxBitrate:r.high},{rid:"m",active:!0,maxBitrate:r.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:r.low,scaleResolutionDownBy:4}]});o&&(t=o.sender)}else t=a.pc.addTrack(e,i);if(t&&a.senderTransforms){var s=null;RTCRtpSender.prototype.createEncodedStreams?s=t.createEncodedStreams():(RTCRtpSender.prototype.createAudioEncodedStreams||RTCRtpSender.prototype.createEncodedVideoStreams)&&("audio"===t.track.kind&&a.senderTransforms.audio?s=t.createEncodedAudioStreams():"video"===t.track.kind&&a.senderTransforms.video&&(s=t.createEncodedVideoStreams())),s&&(s.readableStream&&s.writableStream?s.readableStream.pipeThrough(a.senderTransforms[t.track.kind]).pipeTo(s.writableStream):s.readable&&s.writable&&s.readable.pipeThrough(a.senderTransforms[t.track.kind]).pipeTo(s.writable))}}))}(function(e){return c.debug("isDataEnabled:",e),"edge"===c.webRTCAdapter.browserDetails.browser?(c.warn("Edge doesn't support data channels yet"),!1):null!=e&&!0===e.data})(r)&&!a.dataChannel[c.dataChanDefaultLabel]&&(c.log("Creating default data channel"),O(e,c.dataChanDefaultLabel,null,!1),a.pc.ondatachannel=function(t){c.log("Data channel created by Janus:",t),O(e,t.channel.label,t.channel.protocol,t.channel)}),a.myStream&&o.onlocalstream(a.myStream),t?a.pc.setRemoteDescription(t).then((function(){if(c.log("Remote description accepted!"),a.remoteSdp=t.sdp,a.candidates&&a.candidates.length>0){for(var i=0;i<a.candidates.length;i++){var o=a.candidates[i];c.debug("Adding remote candidate:",o),o&&!0!==o.completed?a.pc.addIceCandidate(o):a.pc.addIceCandidate(c.endOfCandidates)}a.candidates=[]}!function(e,t,r){(r=r||{}).success="function"==typeof r.success?r.success:c.noop,r.error="function"==typeof r.error?r.error:c.noop,r.customizeSdp="function"==typeof r.customizeSdp?r.customizeSdp:c.noop;var n=T[e];if(!n||!n.webrtcStuff)return c.warn("Invalid handle"),void r.error("Invalid handle");var i=n.webrtcStuff,o=!0===r.simulcast;o?c.log("Creating answer (iceDone="+i.iceDone+", simulcast="+o+")"):c.log("Creating answer (iceDone="+i.iceDone+")");var a=null;if(c.unifiedPlan){a={};var s=null,d=null,u=i.pc.getTransceivers();if(u&&u.length>0)for(var l of u)l.sender&&l.sender.track&&"audio"===l.sender.track.kind||l.receiver&&l.receiver.track&&"audio"===l.receiver.track.kind?s||(s=l):(l.sender&&l.sender.track&&"video"===l.sender.track.kind||l.receiver&&l.receiver.track&&"video"===l.receiver.track.kind)&&(d||(d=l));var f=W(t),p=z(t);if(f||p){if(f&&p){if(s)try{s.setDirection?s.setDirection("sendrecv"):s.direction="sendrecv",c.log("Setting audio transceiver to sendrecv:",s)}catch(e){c.error(e)}}else if(f&&!p)try{s&&(s.setDirection?s.setDirection("sendonly"):s.direction="sendonly",c.log("Setting audio transceiver to sendonly:",s))}catch(e){c.error(e)}else if(!f&&p)if(s)try{s.setDirection?s.setDirection("recvonly"):s.direction="recvonly",c.log("Setting audio transceiver to recvonly:",s)}catch(e){c.error(e)}else s=i.pc.addTransceiver("audio",{direction:"recvonly"}),c.log("Adding recvonly audio transceiver:",s)}else if(t.removeAudio&&s)try{s.setDirection?s.setDirection("inactive"):s.direction="inactive",c.log("Setting audio transceiver to inactive:",s)}catch(e){c.error(e)}var v=H(t),m=$(t);if(v||m){if(v&&m){if(d)try{d.setDirection?d.setDirection("sendrecv"):d.direction="sendrecv",c.log("Setting video transceiver to sendrecv:",d)}catch(e){c.error(e)}}else if(v&&!m){if(d)try{d.setDirection?d.setDirection("sendonly"):d.direction="sendonly",c.log("Setting video transceiver to sendonly:",d)}catch(e){c.error(e)}}else if(!v&&m)if(d)try{d.setDirection?d.setDirection("recvonly"):d.direction="recvonly",c.log("Setting video transceiver to recvonly:",d)}catch(e){c.error(e)}else d=i.pc.addTransceiver("video",{direction:"recvonly"}),c.log("Adding recvonly video transceiver:",d)}else if(t.removeVideo&&d)try{d.setDirection?d.setDirection("inactive"):d.direction="inactive",c.log("Setting video transceiver to inactive:",d)}catch(e){c.error(e)}}else a="firefox"===c.webRTCAdapter.browserDetails.browser||"edge"===c.webRTCAdapter.browserDetails.browser?{offerToReceiveAudio:z(t),offerToReceiveVideo:$(t)}:{mandatory:{OfferToReceiveAudio:z(t),OfferToReceiveVideo:$(t)}};c.debug(a);var g=H(t);if(g&&o&&"firefox"===c.webRTCAdapter.browserDetails.browser){c.log("Enabling Simulcasting for Firefox (RID)");var h=i.pc.getSenders()[1];c.log(h);var b=h.getParameters();c.log(b);var y=w(r.simulcastMaxBitrates);h.setParameters({encodings:r.sendEncodings||[{rid:"h",active:!0,maxBitrate:y.high},{rid:"m",active:!0,maxBitrate:y.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:y.low,scaleResolutionDownBy:4}]})}i.pc.createAnswer(a).then((function(e){c.debug(e);var t={type:e.type,sdp:e.sdp};r.customizeSdp(t),e.sdp=t.sdp,c.log("Setting local description"),g&&o&&("chrome"===c.webRTCAdapter.browserDetails.browser?c.warn("simulcast=true, but this is an answer, and video breaks in Chrome if we enable it"):"firefox"!==c.webRTCAdapter.browserDetails.browser&&c.warn("simulcast=true, but this is not Chrome nor Firefox, ignoring")),i.mySdp=e.sdp,i.pc.setLocalDescription(e).catch(r.error),i.mediaConstraints=a,i.iceDone||i.trickle?((i.senderTransforms||i.receiverTransforms)&&(e.e2ee=!0),r.success(e)):c.log("Waiting for all candidates...")}),r.error)}(e,r,n)}),n.error):function(e,t,r){(r=r||{}).success="function"==typeof r.success?r.success:c.noop,r.error="function"==typeof r.error?r.error:c.noop,r.customizeSdp="function"==typeof r.customizeSdp?r.customizeSdp:c.noop;var n=T[e];if(!n||!n.webrtcStuff)return c.warn("Invalid handle"),void r.error("Invalid handle");var i=n.webrtcStuff,o=!0===r.simulcast;o?c.log("Creating offer (iceDone="+i.iceDone+", simulcast="+o+")"):c.log("Creating offer (iceDone="+i.iceDone+")");var a={};if(c.unifiedPlan){var s=null,d=null,u=i.pc.getTransceivers();if(u&&u.length>0)for(var l of u)l.sender&&l.sender.track&&"audio"===l.sender.track.kind||l.receiver&&l.receiver.track&&"audio"===l.receiver.track.kind?s||(s=l):(l.sender&&l.sender.track&&"video"===l.sender.track.kind||l.receiver&&l.receiver.track&&"video"===l.receiver.track.kind)&&(d||(d=l));var f=W(t),p=z(t);f||p?f&&p?s&&(s.setDirection?s.setDirection("sendrecv"):s.direction="sendrecv",c.log("Setting audio transceiver to sendrecv:",s)):f&&!p?s&&(s.setDirection?s.setDirection("sendonly"):s.direction="sendonly",c.log("Setting audio transceiver to sendonly:",s)):!f&&p&&(s?(s.setDirection?s.setDirection("recvonly"):s.direction="recvonly",c.log("Setting audio transceiver to recvonly:",s)):(s=i.pc.addTransceiver("audio",{direction:"recvonly"}),c.log("Adding recvonly audio transceiver:",s))):t.removeAudio&&s&&(s.setDirection?s.setDirection("inactive"):s.direction="inactive",c.log("Setting audio transceiver to inactive:",s));var v=H(t),m=$(t);v||m?v&&m?d&&(d.setDirection?d.setDirection("sendrecv"):d.direction="sendrecv",c.log("Setting video transceiver to sendrecv:",d)):v&&!m?d&&(d.setDirection?d.setDirection("sendonly"):d.direction="sendonly",c.log("Setting video transceiver to sendonly:",d)):!v&&m&&(d?(d.setDirection?d.setDirection("recvonly"):d.direction="recvonly",c.log("Setting video transceiver to recvonly:",d)):(d=i.pc.addTransceiver("video",{direction:"recvonly"}),c.log("Adding recvonly video transceiver:",d))):t.removeVideo&&d&&(d.setDirection?d.setDirection("inactive"):d.direction="inactive",c.log("Setting video transceiver to inactive:",d))}else a.offerToReceiveAudio=z(t),a.offerToReceiveVideo=$(t);!0===r.iceRestart&&(a.iceRestart=!0),c.debug(a);var g=H(t);if(g&&o&&"firefox"===c.webRTCAdapter.browserDetails.browser){c.log("Enabling Simulcasting for Firefox (RID)");var h=i.pc.getSenders().find((function(e){return"video"===e.track.kind}));if(h){var b=h.getParameters();b||(b={});var y=w(r.simulcastMaxBitrates);b.encodings=r.sendEncodings||[{rid:"h",active:!0,maxBitrate:y.high},{rid:"m",active:!0,maxBitrate:y.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:y.low,scaleResolutionDownBy:4}],h.setParameters(b)}}i.pc.createOffer(a).then((function(e){c.debug(e);var t={type:e.type,sdp:e.sdp};r.customizeSdp(t),e.sdp=t.sdp,c.log("Setting local description"),g&&o&&("chrome"===c.webRTCAdapter.browserDetails.browser||"safari"===c.webRTCAdapter.browserDetails.browser?(c.log("Enabling Simulcasting for Chrome (SDP munging)"),e.sdp=function(e){for(var t=e.split("\r\n"),r=!1,n=[-1],i=[-1],o=null,a=null,s=null,d=null,u=-1,l=0;l<t.length;l++)if(p=t[l].match(/m=(\w+) */)){if("video"===p[1]){if(!(n[0]<0)){u=l;break}r=!0}else if(n[0]>-1){u=l;break}}else if(r){var f=t[l].match(/a=ssrc-group:FID (\d+) (\d+)/);if(f)n[0]=f[1],i[0]=f[2],t.splice(l,1),l--;else{if(n[0]){if((m=t[l].match("a=ssrc:"+n[0]+" cname:(.+)"))&&(o=m[1]),(m=t[l].match("a=ssrc:"+n[0]+" msid:(.+)"))&&(a=m[1]),(m=t[l].match("a=ssrc:"+n[0]+" mslabel:(.+)"))&&(s=m[1]),(m=t[l].match("a=ssrc:"+n[0]+" label:(.+)"))&&(d=m[1]),0===t[l].indexOf("a=ssrc:"+i[0])){t.splice(l,1),l--;continue}if(0===t[l].indexOf("a=ssrc:"+n[0])){t.splice(l,1),l--;continue}}0!=t[l].length||(t.splice(l,1),l--)}}if(n[0]<0)for(u=-1,r=!1,l=0;l<t.length;l++){var p;if(p=t[l].match(/m=(\w+) */)){if("video"===p[1]){if(!(n[0]<0)){u=l;break}r=!0}else if(n[0]>-1){u=l;break}}else if(r){if(n[0]<0){var v=t[l].match(/a=ssrc:(\d+)/);if(v){n[0]=v[1],t.splice(l,1),l--;continue}}else{var m;if((m=t[l].match("a=ssrc:"+n[0]+" cname:(.+)"))&&(o=m[1]),(m=t[l].match("a=ssrc:"+n[0]+" msid:(.+)"))&&(a=m[1]),(m=t[l].match("a=ssrc:"+n[0]+" mslabel:(.+)"))&&(s=m[1]),(m=t[l].match("a=ssrc:"+n[0]+" label:(.+)"))&&(d=m[1]),0===t[l].indexOf("a=ssrc:"+i[0])){t.splice(l,1),l--;continue}if(0===t[l].indexOf("a=ssrc:"+n[0])){t.splice(l,1),l--;continue}}0!==t[l].length||(t.splice(l,1),l--)}}if(n[0]<0)return c.warn("Couldn't find the video SSRC, simulcasting NOT enabled"),e;for(u<0&&(u=t.length),n[1]=Math.floor(4294967295*Math.random()),n[2]=Math.floor(4294967295*Math.random()),i[1]=Math.floor(4294967295*Math.random()),i[2]=Math.floor(4294967295*Math.random()),l=0;l<n.length;l++)o&&(t.splice(u,0,"a=ssrc:"+n[l]+" cname:"+o),u++),a&&(t.splice(u,0,"a=ssrc:"+n[l]+" msid:"+a),u++),s&&(t.splice(u,0,"a=ssrc:"+n[l]+" mslabel:"+s),u++),d&&(t.splice(u,0,"a=ssrc:"+n[l]+" label:"+d),u++),o&&(t.splice(u,0,"a=ssrc:"+i[l]+" cname:"+o),u++),a&&(t.splice(u,0,"a=ssrc:"+i[l]+" msid:"+a),u++),s&&(t.splice(u,0,"a=ssrc:"+i[l]+" mslabel:"+s),u++),d&&(t.splice(u,0,"a=ssrc:"+i[l]+" label:"+d),u++);return t.splice(u,0,"a=ssrc-group:FID "+n[2]+" "+i[2]),t.splice(u,0,"a=ssrc-group:FID "+n[1]+" "+i[1]),t.splice(u,0,"a=ssrc-group:FID "+n[0]+" "+i[0]),t.splice(u,0,"a=ssrc-group:SIM "+n[0]+" "+n[1]+" "+n[2]),(e=t.join("\r\n")).endsWith("\r\n")||(e+="\r\n"),e}(e.sdp)):"firefox"!==c.webRTCAdapter.browserDetails.browser&&c.warn("simulcast=true, but this is not Chrome nor Firefox, ignoring")),i.mySdp=e.sdp,i.pc.setLocalDescription(e).catch(r.error),i.mediaConstraints=a,i.iceDone||i.trickle?((i.senderTransforms||i.receiverTransforms)&&(e.e2ee=!0),r.success(e)):c.log("Waiting for all candidates...")}),r.error)}(e,r,n)}function _(e,t,r){(r=r||{}).success="function"==typeof r.success?r.success:c.noop,r.error="function"==typeof r.error?r.error:J;var n=r.jsep;if(t&&n)return c.error("Provided a JSEP to a createOffer"),void r.error("Provided a JSEP to a createOffer");if(!(t||n&&n.type&&n.sdp))return c.error("A valid JSEP is required for createAnswer"),void r.error("A valid JSEP is required for createAnswer");r.media="object"==typeof r.media&&r.media?r.media:{audio:!0,video:!0};var i=r.media,o=T[e];if(!o||!o.webrtcStuff)return c.warn("Invalid handle"),void r.error("Invalid handle");var a,s=o.webrtcStuff;if(s.trickle=(a=r.trickle,c.debug("isTrickleEnabled:",a),!1!==a),s.pc){if(c.log("Updating existing media session"),i.update=!0,r.stream)r.stream!==s.myStream&&c.log("Renegotiation involves a new external stream");else{if(i.addAudio){if(i.keepAudio=!1,i.replaceAudio=!1,i.removeAudio=!1,i.audioSend=!0,s.myStream&&s.myStream.getAudioTracks()&&s.myStream.getAudioTracks().length)return c.error("Can't add audio stream, there already is one"),void r.error("Can't add audio stream, there already is one")}else i.removeAudio?(i.keepAudio=!1,i.replaceAudio=!1,i.addAudio=!1,i.audioSend=!1):i.replaceAudio&&(i.keepAudio=!1,i.addAudio=!1,i.removeAudio=!1,i.audioSend=!0);if(s.myStream&&s.myStream.getAudioTracks()&&0!==s.myStream.getAudioTracks().length?!W(i)||i.removeAudio||i.replaceAudio||(i.keepAudio=!0):(i.replaceAudio&&(i.keepAudio=!1,i.replaceAudio=!1,i.addAudio=!0,i.audioSend=!0),W(i)&&(i.keepAudio=!1,i.addAudio=!0)),i.addVideo){if(i.keepVideo=!1,i.replaceVideo=!1,i.removeVideo=!1,i.videoSend=!0,s.myStream&&s.myStream.getVideoTracks()&&s.myStream.getVideoTracks().length)return c.error("Can't add video stream, there already is one"),void r.error("Can't add video stream, there already is one")}else i.removeVideo?(i.keepVideo=!1,i.replaceVideo=!1,i.addVideo=!1,i.videoSend=!1):i.replaceVideo&&(i.keepVideo=!1,i.addVideo=!1,i.removeVideo=!1,i.videoSend=!0);s.myStream&&s.myStream.getVideoTracks()&&0!==s.myStream.getVideoTracks().length?!H(i)||i.removeVideo||i.replaceVideo||(i.keepVideo=!0):(i.replaceVideo&&(i.keepVideo=!1,i.replaceVideo=!1,i.addVideo=!0,i.videoSend=!0),H(i)&&(i.keepVideo=!1,i.addVideo=!0)),i.addData&&(i.data=!0)}if(W(i)&&i.keepAudio&&H(i)&&i.keepVideo)return o.consentDialog(!1),void V(e,n,i,r,s.myStream)}else i.update=!1,i.keepAudio=!1,i.keepVideo=!1;if(i.update&&!s.streamExternal){if(i.removeAudio||i.replaceAudio){if(s.myStream&&s.myStream.getAudioTracks()&&s.myStream.getAudioTracks().length){var d=s.myStream.getAudioTracks()[0];c.log("Removing audio track:",d),s.myStream.removeTrack(d);try{d.stop()}catch(P){}}if(s.pc.getSenders()&&s.pc.getSenders().length){var u=!0;if(i.replaceAudio&&c.unifiedPlan&&(u=!1),u)for(var l of s.pc.getSenders())l&&l.track&&"audio"===l.track.kind&&(c.log("Removing audio sender:",l),s.pc.removeTrack(l))}}if(i.removeVideo||i.replaceVideo){if(s.myStream&&s.myStream.getVideoTracks()&&s.myStream.getVideoTracks().length){var f=s.myStream.getVideoTracks()[0];c.log("Removing video track:",f),s.myStream.removeTrack(f);try{f.stop()}catch(E){}}if(s.pc.getSenders()&&s.pc.getSenders().length){var p=!0;if(i.replaceVideo&&c.unifiedPlan&&(p=!1),p)for(var v of s.pc.getSenders())v&&v.track&&"video"===v.track.kind&&(c.log("Removing video sender:",v),s.pc.removeTrack(v))}}}if(r.stream){var m=r.stream;return c.log("MediaStream provided by the application"),c.debug(m),i.update&&s.myStream&&s.myStream!==r.stream&&!s.streamExternal&&(c.stopAllTracks(s.myStream),s.myStream=null),s.streamExternal=!0,o.consentDialog(!1),void V(e,n,i,r,m)}if(W(i)||H(i)){if(!c.isGetUserMediaAvailable())return void r.error("getUserMedia not available");var g={mandatory:{},optional:[]};o.consentDialog(!0);var h=W(i);h&&i&&"object"==typeof i.audio&&(h=i.audio);var b=H(i);if(b&&i){var w=!0===r.simulcast,y=!0===r.simulcast2;if(!w&&!y||n||i.video||(i.video="hires"),i.video&&"screen"!=i.video&&"window"!=i.video)if("object"==typeof i.video)b=i.video;else{var S=0,C=0;"lowres"===i.video?(C=240,S=320):"lowres-16:9"===i.video?(C=180,S=320):"hires"===i.video||"hires-16:9"===i.video||"hdres"===i.video?(C=720,S=1280):"fhdres"===i.video?(C=1080,S=1920):"4kres"===i.video?(C=2160,S=3840):"stdres"===i.video?(C=480,S=640):"stdres-16:9"===i.video?(C=360,S=640):(c.log("Default video setting is stdres 4:3"),C=480,S=640),c.log("Adding media constraint:",i.video),b={height:{ideal:C},width:{ideal:S}},c.log("Adding video constraint:",b)}else if("screen"===i.video||"window"===i.video){if(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia)return g.video={},i.screenshareFrameRate&&(g.video.frameRate=i.screenshareFrameRate),i.screenshareHeight&&(g.video.height=i.screenshareHeight),i.screenshareWidth&&(g.video.width=i.screenshareWidth),g.audio=i.captureDesktopAudio,void navigator.mediaDevices.getDisplayMedia(g).then((function(t){o.consentDialog(!1),W(i)&&!i.keepAudio?navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then((function(o){t.addTrack(o.getAudioTracks()[0]),V(e,n,i,r,t)})):V(e,n,i,r,t)}),(function(e){o.consentDialog(!1),r.error(e)}));function x(t,a){o.consentDialog(!1),t?r.error(t):V(e,n,i,r,a)}function A(e,t,r){c.log("Adding media constraint (screen capture)"),c.debug(e),navigator.mediaDevices.getUserMedia(e).then((function(e){r?navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then((function(r){e.addTrack(r.getAudioTracks()[0]),t(null,e)})):t(null,e)})).catch((function(e){o.consentDialog(!1),t(e)}))}if("chrome"===c.webRTCAdapter.browserDetails.browser){var k=c.webRTCAdapter.browserDetails.version,R=33;window.navigator.userAgent.match("Linux")&&(R=35),k>=26&&k<=R?A(g={video:{mandatory:{googLeakyBucket:!0,maxWidth:window.screen.width,maxHeight:window.screen.height,minFrameRate:i.screenshareFrameRate,maxFrameRate:i.screenshareFrameRate,chromeMediaSource:"screen"}},audio:W(i)&&!i.keepAudio},x):c.extension.getScreen((function(e,t){if(e)return o.consentDialog(!1),r.error(e);(g={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",maxWidth:window.screen.width,maxHeight:window.screen.height,minFrameRate:i.screenshareFrameRate,maxFrameRate:i.screenshareFrameRate},optional:[{googLeakyBucket:!0},{googTemporalLayeredScreencast:!0}]}}).video.mandatory.chromeMediaSourceId=t,A(g,x,W(i)&&!i.keepAudio)}))}else if("firefox"===c.webRTCAdapter.browserDetails.browser){if(!(c.webRTCAdapter.browserDetails.version>=33)){var D=new Error("NavigatorUserMediaError");return D.name="Your version of Firefox does not support screen sharing, please install Firefox 33 (or more recent versions)",o.consentDialog(!1),void r.error(D)}A(g={video:{mozMediaSource:i.video,mediaSource:i.video},audio:W(i)&&!i.keepAudio},(function(e,t){if(x(e,t),!e)var r=t.currentTime,n=window.setInterval((function(){t||window.clearInterval(n),t.currentTime==r&&(window.clearInterval(n),t.onended&&t.onended()),r=t.currentTime}),500)}))}return}}i&&"screen"===i.video||navigator.mediaDevices.enumerateDevices().then((function(t){var a=t.some((function(e){return"audioinput"===e.kind})),s=function(e){if(c.debug("isScreenSendEnabled:",e),!e)return!1;if("object"!=typeof e.video||"object"!=typeof e.video.mandatory)return!1;var t=e.video.mandatory;return t.chromeMediaSource?"desktop"===t.chromeMediaSource||"screen"===t.chromeMediaSource:t.mozMediaSource?"window"===t.mozMediaSource||"screen"===t.mozMediaSource:!!t.mediaSource&&("window"===t.mediaSource||"screen"===t.mediaSource)}(i)||t.some((function(e){return"videoinput"===e.kind})),d=W(i),u=H(i),l=function(e){return c.debug("isAudioSendRequired:",e),!!e&&!1!==e.audio&&!1!==e.audioSend&&void 0!==e.failIfNoAudio&&null!==e.failIfNoAudio&&!0===e.failIfNoAudio}(i),f=function(e){return c.debug("isVideoSendRequired:",e),!!e&&!1!==e.video&&!1!==e.videoSend&&void 0!==e.failIfNoVideo&&null!==e.failIfNoVideo&&!0===e.failIfNoVideo}(i);if(d||u||l||f){var p=!!d&&a,v=!!u&&s;if(!p&&!v)return o.consentDialog(!1),r.error("No capture device found"),!1;if(!p&&l)return o.consentDialog(!1),r.error("Audio capture is required, but no capture device found"),!1;if(!v&&f)return o.consentDialog(!1),r.error("Video capture is required, but no capture device found"),!1}var g={audio:!(!a||i.keepAudio)&&h,video:!(!s||i.keepVideo)&&b};c.debug("getUserMedia constraints",g),g.audio||g.video?navigator.mediaDevices.getUserMedia(g).then((function(t){o.consentDialog(!1),V(e,n,i,r,t)})).catch((function(e){o.consentDialog(!1),r.error({code:e.code,name:e.name,message:e.message})})):(o.consentDialog(!1),V(e,n,i,r,m))})).catch((function(e){o.consentDialog(!1),r.error(e)}))}else console.log("Else de audio o video deshabilitado"),V(e,n,i,r)}function U(e,t){(t=t||{}).success="function"==typeof t.success?t.success:c.noop,t.error="function"==typeof t.error?t.error:J;var r=t.jsep,n=T[e];if(!n||!n.webrtcStuff)return c.warn("Invalid handle"),void t.error("Invalid handle");var i=n.webrtcStuff;if(r){if(!i.pc)return c.warn("Wait, no PeerConnection?? if this is an answer, use createAnswer and not handleRemoteJsep"),void t.error("No PeerConnection: if this is an answer, use createAnswer and not handleRemoteJsep");i.pc.setRemoteDescription(r).then((function(){if(c.log("Remote description accepted!"),i.remoteSdp=r.sdp,i.candidates&&i.candidates.length>0){for(var e=0;e<i.candidates.length;e++){var n=i.candidates[e];c.debug("Adding remote candidate:",n),n&&!0!==n.completed?i.pc.addIceCandidate(n):i.pc.addIceCandidate(c.endOfCandidates)}i.candidates=[]}t.success()}),t.error)}else t.error("Invalid JSEP")}function N(e,t){var r=T[e];if(!r||!r.webrtcStuff)return c.warn("Invalid handle"),0;var n=t?"remote":"local",i=r.webrtcStuff;return i.volume[n]||(i.volume[n]={value:0}),!i.pc.getStats||"chrome"!==c.webRTCAdapter.browserDetails.browser&&"safari"!==c.webRTCAdapter.browserDetails.browser?(c.warn("Getting the "+n+" volume unsupported by browser"),0):t&&!i.remoteStream?(c.warn("Remote stream unavailable"),0):t||i.myStream?i.volume[n].timer?i.volume[n].value:(c.log("Starting "+n+" volume monitor"),i.volume[n].timer=setInterval((function(){i.pc.getStats().then((function(e){e.forEach((function(e){e&&"audio"===e.kind&&(t&&!e.remoteSource||!t&&"media-source"!==e.type||(i.volume[n].value=e.audioLevel?e.audioLevel:0))}))}))}),200),0):(c.warn("Local stream unavailable"),0)}function F(e,t){var r=T[e];if(!r||!r.webrtcStuff)return c.warn("Invalid handle"),!0;var n=r.webrtcStuff;return n.pc?n.myStream?t?n.myStream.getVideoTracks()&&0!==n.myStream.getVideoTracks().length?!n.myStream.getVideoTracks()[0].enabled:(c.warn("No video track"),!0):n.myStream.getAudioTracks()&&0!==n.myStream.getAudioTracks().length?!n.myStream.getAudioTracks()[0].enabled:(c.warn("No audio track"),!0):(c.warn("Invalid local MediaStream"),!0):(c.warn("Invalid PeerConnection"),!0)}function G(e,t,r){var n=T[e];if(!n||!n.webrtcStuff)return c.warn("Invalid handle"),!1;var i=n.webrtcStuff;return i.pc?i.myStream?t?i.myStream.getVideoTracks()&&0!==i.myStream.getVideoTracks().length?(i.myStream.getVideoTracks()[0].enabled=!r,!0):(c.warn("No video track"),!1):i.myStream.getAudioTracks()&&0!==i.myStream.getAudioTracks().length?(i.myStream.getAudioTracks()[0].enabled=!r,!0):(c.warn("No audio track"),!1):(c.warn("Invalid local MediaStream"),!1):(c.warn("Invalid PeerConnection"),!1)}function B(e){var t=T[e];if(!t||!t.webrtcStuff)return c.warn("Invalid handle"),"Invalid handle";var r=t.webrtcStuff;return r.pc?r.pc.getStats?r.bitrate.timer?r.bitrate.value:(c.log("Starting bitrate timer (via getStats)"),r.bitrate.timer=setInterval((function(){r.pc.getStats().then((function(e){e.forEach((function(e){if(e){var t=!1;if(("video"===e.mediaType||e.id.toLowerCase().indexOf("video")>-1)&&"inbound-rtp"===e.type&&e.id.indexOf("rtcp")<0?t=!0:"ssrc"!=e.type||!e.bytesReceived||"VP8"!==e.googCodecName&&""!==e.googCodecName||(t=!0),t)if(r.bitrate.bsnow=e.bytesReceived,r.bitrate.tsnow=e.timestamp,null===r.bitrate.bsbefore||null===r.bitrate.tsbefore)r.bitrate.bsbefore=r.bitrate.bsnow,r.bitrate.tsbefore=r.bitrate.tsnow;else{var n=r.bitrate.tsnow-r.bitrate.tsbefore;"safari"===c.webRTCAdapter.browserDetails.browser&&(n/=1e3);var i=Math.round(8*(r.bitrate.bsnow-r.bitrate.bsbefore)/n);"safari"===c.webRTCAdapter.browserDetails.browser&&(i=parseInt(i/1e3)),r.bitrate.value=i+" kbits/sec",r.bitrate.bsbefore=r.bitrate.bsnow,r.bitrate.tsbefore=r.bitrate.tsnow}}}))}))}),1e3),"0 kbits/sec"):(c.warn("Getting the video bitrate unsupported by browser"),"Feature unsupported by browser"):"Invalid PeerConnection"}function J(e){c.error("WebRTC error:",e)}function q(e,n){c.log("Cleaning WebRTC stuff");var i=T[e];if(i){var o=i.webrtcStuff;if(o){if(!0===n){var a={janus:"hangup",transaction:c.randomString(12)};i.token&&(a.token=i.token),g&&(a.apisecret=g),c.debug("Sending hangup request (handle="+e+"):"),c.debug(a),t?(a.session_id=S,a.handle_id=e,r.send(JSON.stringify(a))):c.httpAPICall(s+"/"+S+"/"+e,{verb:"POST",withCredentials:p,body:a})}o.remoteStream=null,o.volume&&(o.volume.local&&o.volume.local.timer&&clearInterval(o.volume.local.timer),o.volume.remote&&o.volume.remote.timer&&clearInterval(o.volume.remote.timer)),o.volume={},o.bitrate.timer&&clearInterval(o.bitrate.timer),o.bitrate.timer=null,o.bitrate.bsnow=null,o.bitrate.bsbefore=null,o.bitrate.tsnow=null,o.bitrate.tsbefore=null,o.bitrate.value=null,!o.streamExternal&&o.myStream&&(c.log("Stopping local stream tracks"),c.stopAllTracks(o.myStream)),o.streamExternal=!1,o.myStream=null;try{o.pc.close()}catch(e){}o.pc=null,o.candidates=null,o.mySdp=null,o.remoteSdp=null,o.iceDone=!1,o.dataChannel={},o.dtmfSender=null,o.senderTransforms=null,o.receiverTransforms=null}i.oncleanup()}}function W(e){return c.debug("isAudioSendEnabled:",e),!e||!1!==e.audio&&(void 0===e.audioSend||null===e.audioSend||!0===e.audioSend)}function z(e){return c.debug("isAudioRecvEnabled:",e),!e||!1!==e.audio&&(void 0===e.audioRecv||null===e.audioRecv||!0===e.audioRecv)}function H(e){return c.debug("isVideoSendEnabled:",e),!e||!1!==e.video&&(void 0===e.videoSend||null===e.videoSend||!0===e.videoSend)}function $(e){return c.debug("isVideoRecvEnabled:",e),!e||!1!==e.video&&(void 0===e.videoRecv||null===e.videoRecv||!0===e.videoRecv)}x(e),this.getServer=function(){return s},this.isConnected=function(){return y},this.reconnect=function(e){(e=e||{}).success="function"==typeof e.success?e.success:c.noop,e.error="function"==typeof e.error?e.error:c.noop,e.reconnect=!0,x(e)},this.getSessionId=function(){return S},this.getInfo=function(e){!function(e){if((e=e||{}).success="function"==typeof e.success?e.success:c.noop,e.error="function"==typeof e.error?e.error:c.noop,c.log("Getting info on Janus instance"),!y)return c.warn("Is the server down? (connected=false)"),void e.error("Is the server down? (connected=false)");var n=c.randomString(12),i={janus:"info",transaction:n};if(m&&(i.token=m),g&&(i.apisecret=g),t)return R[n]=function(t){c.log("Server info:"),c.debug(t),"server_info"!==t.janus&&c.error("Ooops: "+t.error.code+" "+t.error.reason),e.success(t)},void r.send(JSON.stringify(i));c.httpAPICall(s,{verb:"POST",withCredentials:p,body:i,success:function(t){c.log("Server info:"),c.debug(t),"server_info"!==t.janus&&c.error("Ooops: "+t.error.code+" "+t.error.reason),e.success(t)},error:function(t,r){c.error(t+":",r),""===r?e.error(t+": Is the server down?"):e.error(t+": "+r)}})}(e)},this.destroy=function(o){!function(o){(o=o||{}).success="function"==typeof o.success?o.success:c.noop,o.error="function"==typeof o.error?o.error:c.noop;var a=!0===o.unload,d=!0;void 0!==o.notifyDestroyed&&null!==o.notifyDestroyed&&(d=!0===o.notifyDestroyed);var u=!0===o.cleanupHandles;if(c.log("Destroying session "+S+" (unload="+a+")"),!S)return c.warn("No session to destroy"),o.success(),void(d&&e.destroyed());if(u)for(var l in T)L(l,{noRequest:!0});if(!y)return c.warn("Is the server down? (connected=false)"),S=null,void o.success();var f={janus:"destroy",transaction:c.randomString(12)};if(m&&(f.token=m),g&&(f.apisecret=g),a)return t?(r.onclose=null,r.close(),r=null):navigator.sendBeacon(s+"/"+S,JSON.stringify(f)),c.log("Destroyed session:"),S=null,y=!1,o.success(),void(d&&e.destroyed());if(t){f.session_id=S;var v=function(){for(var e in n)r.removeEventListener(e,n[e]);r.removeEventListener("message",h),r.removeEventListener("error",b),i&&clearTimeout(i),r.close()},h=function(t){var r=JSON.parse(t.data);r.session_id==f.session_id&&r.transaction==f.transaction&&(v(),o.success(),d&&e.destroyed())},b=function(t){v(),o.error("Failed to destroy the server: Is the server down?"),d&&e.destroyed()};return r.addEventListener("message",h),r.addEventListener("error",b),void(1===r.readyState?r.send(JSON.stringify(f)):b())}c.httpAPICall(s+"/"+S,{verb:"POST",withCredentials:p,body:f,success:function(t){c.log("Destroyed session:"),c.debug(t),S=null,y=!1,"success"!==t.janus&&c.error("Ooops: "+t.error.code+" "+t.error.reason),o.success(),d&&e.destroyed()},error:function(t,r){c.error(t+":",r),S=null,y=!1,o.success(),d&&e.destroyed()}})}(o)},this.attach=function(e){!function(e){if((e=e||{}).success="function"==typeof e.success?e.success:c.noop,e.error="function"==typeof e.error?e.error:c.noop,e.consentDialog="function"==typeof e.consentDialog?e.consentDialog:c.noop,e.iceState="function"==typeof e.iceState?e.iceState:c.noop,e.mediaState="function"==typeof e.mediaState?e.mediaState:c.noop,e.webrtcState="function"==typeof e.webrtcState?e.webrtcState:c.noop,e.slowLink="function"==typeof e.slowLink?e.slowLink:c.noop,e.onmessage="function"==typeof e.onmessage?e.onmessage:c.noop,e.onlocalstream="function"==typeof e.onlocalstream?e.onlocalstream:c.noop,e.onremotestream="function"==typeof e.onremotestream?e.onremotestream:c.noop,e.ondata="function"==typeof e.ondata?e.ondata:c.noop,e.ondataopen="function"==typeof e.ondataopen?e.ondataopen:c.noop,e.oncleanup="function"==typeof e.oncleanup?e.oncleanup:c.noop,e.ondetached="function"==typeof e.ondetached?e.ondetached:c.noop,!y)return c.warn("Is the server down? (connected=false)"),void e.error("Is the server down? (connected=false)");var n=e.plugin;if(!n)return c.error("Invalid plugin"),void e.error("Invalid plugin");var i=e.opaqueId,o=e.token?e.token:m,a=c.randomString(12),d={janus:"attach",plugin:n,opaque_id:i,transaction:a};if(o&&(d.token=o),g&&(d.apisecret=g),t)return R[a]=function(t){if(c.debug(t),"success"!==t.janus)return c.error("Ooops: "+t.error.code+" "+t.error.reason),void e.error("Ooops: "+t.error.code+" "+t.error.reason);var r=t.data.id;c.log("Created handle: "+r);var i={session:C,plugin:n,id:r,token:o,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,remoteStream:null,mySdp:null,mediaConstraints:null,pc:null,dataChannel:{},dtmfSender:null,trickle:!0,iceDone:!1,volume:{value:null,timer:null},bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null}},getId:function(){return r},getPlugin:function(){return n},getVolume:function(){return N(r,!0)},getRemoteVolume:function(){return N(r,!0)},getLocalVolume:function(){return N(r,!1)},isAudioMuted:function(){return F(r,!1)},muteAudio:function(){return G(r,!1,!0)},unmuteAudio:function(){return G(r,!1,!1)},isVideoMuted:function(){return F(r,!0)},muteVideo:function(){return G(r,!0,!0)},unmuteVideo:function(){return G(r,!0,!1)},getBitrate:function(){return B(r)},send:function(e){A(r,e)},data:function(e){M(r,e)},dtmf:function(e){j(r,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){_(r,!0,e)},createAnswer:function(e){_(r,!1,e)},handleRemoteJsep:function(e){U(r,e)},onlocalstream:e.onlocalstream,onremotestream:e.onremotestream,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){q(r,!0===e)},detach:function(e){L(r,e)}};T[r]=i,e.success(i)},d.session_id=S,void r.send(JSON.stringify(d));c.httpAPICall(s+"/"+S,{verb:"POST",withCredentials:p,body:d,success:function(t){if(c.debug(t),"success"!==t.janus)return c.error("Ooops: "+t.error.code+" "+t.error.reason),void e.error("Ooops: "+t.error.code+" "+t.error.reason);var r=t.data.id;c.log("Created handle: "+r);var i={session:C,plugin:n,id:r,token:o,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,remoteStream:null,mySdp:null,mediaConstraints:null,pc:null,dataChannel:{},dtmfSender:null,trickle:!0,iceDone:!1,volume:{value:null,timer:null},bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null}},getId:function(){return r},getPlugin:function(){return n},getVolume:function(){return N(r,!0)},getRemoteVolume:function(){return N(r,!0)},getLocalVolume:function(){return N(r,!1)},isAudioMuted:function(){return F(r,!1)},muteAudio:function(){return G(r,!1,!0)},unmuteAudio:function(){return G(r,!1,!1)},isVideoMuted:function(){return F(r,!0)},muteVideo:function(){return G(r,!0,!0)},unmuteVideo:function(){return G(r,!0,!1)},getBitrate:function(){return B(r)},send:function(e){A(r,e)},data:function(e){M(r,e)},dtmf:function(e){j(r,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){_(r,!0,e)},createAnswer:function(e){_(r,!1,e)},handleRemoteJsep:function(e){U(r,e)},onlocalstream:e.onlocalstream,onremotestream:e.onremotestream,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){q(r,!0===e)},detach:function(e){L(r,e)}};T[r]=i,e.success(i)},error:function(t,r){c.error(t+":",r),""===r?e.error(t+": Is the server down?"):e.error(t+": "+r)}})}(e)}}c.useDefaultDependencies=function(e){var t=e&&e.fetch||fetch,r=e&&e.Promise||Promise,n=e&&e.WebSocket||WebSocket;return{newWebSocket:function(e,t){return new n(e,t)},extension:e&&e.extension||s,isArray:function(e){return Array.isArray(e)},webRTCAdapter:e&&e.adapter||a(),httpAPICall:function(e,n){var i={method:n.verb,headers:{Accept:"application/json, text/plain, */*"},cache:"no-cache"};"POST"===n.verb&&(i.headers["Content-Type"]="application/json"),void 0!==n.withCredentials&&(i.credentials=!0===n.withCredentials?"include":n.withCredentials?n.withCredentials:"omit"),n.body&&(i.body=JSON.stringify(n.body));var o=t(e,i).catch((function(e){return r.reject({message:"Probably a network error, is the server down?",error:e})}));if(n.timeout){var a=new r((function(e,t){var r=setTimeout((function(){return clearTimeout(r),t({message:"Request timed out",timeout:n.timeout})}),n.timeout)}));o=r.race([o,a])}return o.then((function(e){return e.ok?typeof n.success==typeof c.noop?e.json().then((function(e){n.success(e)})).catch((function(t){return r.reject({message:"Failed to parse response body",error:t,response:e})})):void 0:r.reject({message:"API call failed",response:e})})).catch((function(e){typeof n.error==typeof c.noop&&n.error(e.message||"<< internal error >>",e)})),o}}},c.useOldDependencies=function(e){var t=e&&e.jQuery||jQuery,r=e&&e.WebSocket||WebSocket;return{newWebSocket:function(e,t){return new r(e,t)},isArray:function(e){return t.isArray(e)},extension:e&&e.extension||s,webRTCAdapter:e&&e.adapter||a(),httpAPICall:function(e,r){var n=void 0!==r.body?{contentType:"application/json",data:JSON.stringify(r.body)}:{},i=void 0!==r.withCredentials?{xhrFields:{withCredentials:r.withCredentials}}:{};return t.ajax(t.extend(n,i,{url:e,type:r.verb,cache:!1,dataType:"json",async:r.async,timeout:r.timeout,success:function(e){typeof r.success==typeof c.noop&&r.success(e)},error:function(e,t,n){typeof r.error==typeof c.noop&&r.error(t,n)}}))}}},c.noop=function(){},c.dataChanDefaultLabel="JanusDataChannel",c.endOfCandidates=null,c.stopAllTracks=function(e){try{var t=e.getTracks();for(var r of t)c.log(r),r&&r.stop()}catch(e){}},c.init=function(e){if((e=e||{}).callback="function"==typeof e.callback?e.callback:c.noop,c.initDone)e.callback();else{if("undefined"!=typeof console&&void 0!==console.log||(console={log:function(){}}),c.trace=c.noop,c.debug=c.noop,c.vdebug=c.noop,c.log=c.noop,c.warn=c.noop,c.error=c.noop,!0===e.debug||"all"===e.debug)c.trace=console.trace.bind(console),c.debug=console.debug.bind(console),c.vdebug=console.debug.bind(console),c.log=console.log.bind(console),c.warn=console.warn.bind(console),c.error=console.error.bind(console);else if(Array.isArray(e.debug))for(var t of e.debug)switch(t){case"trace":c.trace=console.trace.bind(console);break;case"debug":c.debug=console.debug.bind(console);break;case"vdebug":c.vdebug=console.debug.bind(console);break;case"log":c.log=console.log.bind(console);break;case"warn":c.warn=console.warn.bind(console);break;case"error":c.error=console.error.bind(console);break;default:console.error("Unknown debugging option '"+t+"' (supported: 'trace', 'debug', 'vdebug', 'log', warn', 'error')")}c.log("Initializing library");var r=e.dependencies||c.useDefaultDependencies();c.isArray=r.isArray,c.webRTCAdapter=r.webRTCAdapter,c.httpAPICall=r.httpAPICall,c.newWebSocket=r.newWebSocket,c.extension=r.extension,c.extension.init(),c.listDevices=function(e,t){e="function"==typeof e?e:c.noop,null==t&&(t={audio:!0,video:!0}),c.isGetUserMediaAvailable()?navigator.mediaDevices.getUserMedia(t).then((function(t){navigator.mediaDevices.enumerateDevices().then((function(r){c.debug(r),e(r),c.stopAllTracks(t)}))})).catch((function(t){c.error(t),e([])})):(c.warn("navigator.mediaDevices unavailable"),e([]))},c.attachMediaStream=function(e,t){try{e.srcObject=t}catch(r){try{e.src=URL.createObjectURL(t)}catch(e){c.error("Error attaching stream to element")}}},c.reattachMediaStream=function(e,t){try{e.srcObject=t.srcObject}catch(r){try{e.src=t.src}catch(e){c.error("Error reattaching stream to element")}}};var n=["iPad","iPhone","iPod"].indexOf(navigator.platform)>=0?"pagehide":"beforeunload",i=window["on"+n];if(window.addEventListener(n,(function(e){for(var t in c.log("Closing window"),c.sessions)c.sessions[t]&&c.sessions[t].destroyOnUnload&&(c.log("Destroying session "+t),c.sessions[t].destroy({unload:!0,notifyDestroyed:!1}));i&&"function"==typeof i&&i()})),c.safariVp8=!1,"safari"===c.webRTCAdapter.browserDetails.browser&&c.webRTCAdapter.browserDetails.version>=605)if(RTCRtpSender&&RTCRtpSender.getCapabilities&&RTCRtpSender.getCapabilities("video")&&RTCRtpSender.getCapabilities("video").codecs&&RTCRtpSender.getCapabilities("video").codecs.length){for(var o of RTCRtpSender.getCapabilities("video").codecs)if(o&&o.mimeType&&"video/vp8"===o.mimeType.toLowerCase()){c.safariVp8=!0;break}c.safariVp8?c.log("This version of Safari supports VP8"):c.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu")}else{var a=new RTCPeerConnection({});a.createOffer({offerToReceiveVideo:!0}).then((function(e){c.safariVp8=-1!==e.sdp.indexOf("VP8"),c.safariVp8?c.log("This version of Safari supports VP8"):c.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu"),a.close(),a=null}))}if(c.unifiedPlan=!1,"firefox"===c.webRTCAdapter.browserDetails.browser&&c.webRTCAdapter.browserDetails.version>=59)c.unifiedPlan=!0;else if("chrome"===c.webRTCAdapter.browserDetails.browser&&c.webRTCAdapter.browserDetails.version>=72)c.unifiedPlan=!0;else if(window.RTCRtpTransceiver&&"currentDirection"in RTCRtpTransceiver.prototype){var s=new RTCPeerConnection;try{s.addTransceiver("audio"),c.unifiedPlan=!0}catch(e){}s.close()}else c.unifiedPlan=!1;c.initDone=!0,e.callback()}},c.isWebrtcSupported=function(){return!!window.RTCPeerConnection},c.isGetUserMediaAvailable=function(){return navigator.mediaDevices&&navigator.mediaDevices.getUserMedia},c.randomString=function(e){for(var t="",r=0;r<e;r++){var n=Math.floor(62*Math.random());t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".substring(n,n+1)}return t};var d=c;function u(e){for(var t="",r=0;r<e;r++)t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.floor(62*Math.random()));return t}function l(e){for(var t,r=e.length;0!==r;)t=Math.floor(Math.random()*r),r--,[e[r],e[t]]=[e[t],e[r]];return e}function f(e){this.message=e,this.name="NoCaptureDevice"}function p(e){this.message=e,this.name="UnexpectedAnswer"}function v(e){this.message=e,this.name="InvalidHandle"}function m(e){let t,r,n,i,o,a,s,c,m,g,h,b,w,y,S=!1,T=!1,C="default",k=null,R=!1,D="";var P=function(){h=setTimeout((()=>{E(),P()}),3e5)},E=function(){a=e.extension.domain,r&&r.send({message:{authuser:e.extension.number.toString(),display_name:e.extension.displayname,proxy:"sip:"+e.extension.domain,request:"register",username:"sip:"+e.extension.number+"@"+e.extension.domain,secret:e.extension.secret}})};function x(){t.destroy({notifyDestroyed:!0,cleanupHandles:!0,success:()=>{clearTimeout(h),clearTimeout(y)}})}return{startConnection:function(){return new Promise((function(o,a){d.init({debug:!1,callback:function(){t=new d({server:l(e.server),apisecret:e.api_secret,success:function(){return setTimeout((()=>{t.attach({plugin:"janus.plugin.sip",opaqueId:"console-"+d.randomString(12),success:function(e){r=e,E(),P()},error:function(e){m&&m(e)},onremotestream:async e=>{for(n&&d.attachMediaStream(n,e);!w;)await new Promise((e=>setTimeout(e,500)))},onlocalstream:async e=>{b=e,d.attachMediaStream(n,e)},onmessage:function(e,t){e.result&&("registered"===e.result.event&&(S=!0,y=setInterval((()=>{r.send({message:{request:"subscribe",event:"message-summary"},error:()=>{}})}),3e4)),"registered_fail"===e.result.event&&(S=!1),"progress"===e.result.event&&null!=t&&r.handleRemoteJsep({jsep:t,error:function(){console.log("Error")}}),"incomingcall"===e.result.event&&(R=!1,t&&(R=!0)),"incomingcall"===e.result.event&&(D=(new Date).getTime()+"@"+u(10)),"accepted"===e.result.event&&(null!=t&&r.handleRemoteJsep({jsep:t,error:function(e){console.log(e)}}),T=!0),"hangup"===e.result.event&&(T=!1,d.stopAllTracks(b)),"unregistered"===e.result.event&&(clearTimeout(h),E(),P())),i&&i(e,t)}})}),3e3),o()},error:function(e){return a(e)},destroyed:function(e){g&&g(e),e&&console.error(e)}})}})}))},onSipMessage:function(e){i=e},attachAudio:function(e){n=e},getCallTo:function(){return o},getCallToNumber:function(){return s},getIsInCall:()=>T,randomId:function(){return d.randomString(12)},isRegistered:function(){return S},call:function(e,t){return new Promise(((n,i)=>{o=t,s=e,D=(new Date).getTime()+"@"+u(10),(e=e.replace(/[-_+ ()]/g,"")).indexOf("@")<0&&(e+="@"+a),r.createOffer({media:{audioSend:!0,audioRecv:!0,videoSend:!1,videoRecv:!1},success:function(t){return r.send({message:{request:"call",uri:"sip:"+e,call_id:(new Date).getTime()+"@"+u(10)},jsep:t}),n(!0)},error:function(e){return c&&c(e),i(e)}})}))},hold:function(){r.send({message:{request:"hold"}})},mute:function(){r.muteAudio()},unhold:function(){r.send({message:{request:"unhold"}})},unmute:function(){r.unmuteAudio()},answer:function(e){return new Promise(((t,n)=>{(R?r.createAnswer:r.createOffer)({jsep:e,media:{audioSend:!0,audioRecv:!0,video:!1},success:function(e){setTimeout((()=>{r.send({message:{request:"accept"},jsep:e,error:function(e){return new RegExp("469 Unexpected ANSWER").test(e)?(x(),n(new p(e))):"Invalid handle"==e?(x(),n(new v(e))):n(e)},success:()=>t(!0)})}),500)},error:function(e){return"No capture device found"===e?n(new f("No capture device found")):(r.send({message:{request:"decline",code:480}}),n(e))}})}))},hangup:function(){r.send({message:{request:"hangup"}}),r.hangup()},decline:function(){r.send({message:{request:"decline"}})},sendDtmf:function e(t,n=0){if(t.length<2)r.send({message:{request:"dtmf_info",digit:t}});else{if(void 0===t[n])return;r.send({message:{request:"dtmf_info",digit:t[n]},success:()=>{setTimeout((()=>{const r=n+1;void 0!==t[r]&&e(t,r)}),500)},error:r=>{console.log(`Error al enviar el tono DTMF ${t[n]}`,r),e(t,n)}})}},registerSipExtension:E,unregister:function(){r&&r.send({message:{request:"unregister"}})},getCallId:function(){return D},server:function(){return t.getServer()},onCallingError:e=>{c=e},onErrorAttachSip:e=>{m=e},changeMicrophone:function(e){k||(k=e),k=e!==C,C=e,r.createOffer({media:{audioSend:!0,audioRecv:!0,videoSend:!1,videoRecv:!1,replaceAudio:k,audio:{deviceId:{exact:C}}}})},destroy:function(e=null){t.destroy({notifyDestroyed:!0,cleanupHandles:!0,success:()=>{clearTimeout(h),clearTimeout(y),e&&e()}})},onDestroyedSession:e=>{g=e},stopAllTracks:function(){d.stopAllTracks(b)},unregisterSipExtension:function(){r.send({message:{request:"unregister"}})},sessionId:()=>t.getSessionId(),setUniqueId:e=>w=e}}var g={init(e,t,r,n=!1,i=null,o=null,a=null){return new m({server:e,api_secret:t,extension:r,watchRTCEnabled:n,stunServer:i,callbackSocketRemote:o,callbackSocketLocal:a})},randomId(){return d.randomString(12)}};const h=["src","width","height"];var b=(0,e.defineComponent)({props:{phoneStatusStyles:{required:!0,type:Object}}}),w=(n(172),n(262)),y=(0,w.A)(b,[["render",function(t,r,n,i,o,a){return(0,e.openBlock)(),(0,e.createElementBlock)("div",{class:"phone-button",style:(0,e.normalizeStyle)(`width: ${t.phoneStatusStyles.width}; height: ${t.phoneStatusStyles.height}; background: ${t.phoneStatusStyles.background}`)},[t.phoneStatusStyles.image?((0,e.openBlock)(),(0,e.createElementBlock)("img",{key:0,class:"phone-button__widget-icon",src:t.phoneStatusStyles.image.src,alt:"widget-button-icon",width:t.phoneStatusStyles.image.width,height:t.phoneStatusStyles.image.height},null,8,h)):(0,e.createCommentVNode)("v-if",!0)],4)}],["__scopeId","data-v-321397a9"]]),S=(0,e.defineComponent)({components:{PhoneButton:y},props:{callback:{type:String,required:!0},phoneStatusStyles:{type:Object,required:!0}},setup(t){const{initSip:r,isExtensionRegistered:n,callTo:i,isInCall:o}=function(){const t={number:null,secret:"",displayname:"",domain:""},r={number:"",name:""};let n=[],i=[],o="";const a=(0,e.ref)(!1),s=(0,e.ref)(!1);let c=null;const d=(0,e.ref)("");return{isExtensionRegistered:a,initSip:async(e,d)=>{if(!c){const u=await fetch(`http://127.0.0.1:8001/api/phone_widgets/callback/${e}`,{method:"POST"}),l=await u.json();if(i=l.mediaServers,n=i.map((e=>Object.values(e)[0])),o=i.map((e=>Object.values(e)[1])),t.number=l.extension.extension,t.secret=l.extension.secret,t.domain=l.pbxDomain,r.number=l.callTo,c=g.init(n,o[0],t,!1,null,null),!c)return;d&&c.attachAudio(d),await c.startConnection(),c.onSipMessage(((e,t)=>{const r=e.result?e.result.event:"",n=t?t.type:"";"registered"===r&&(a.value=!0),"hangup"===r&&(c?.hangup(),c?.stopAllTracks(),s.value=!1),"accepted"===r&&(s.value=!0),"answer"===n&&s&&d&&(d.volume=1)}))}},callBack:d,callTo:()=>{c?.call(r.number.toString(),r.number.toString()),s.value=!0},isInCall:s}}(),a=(0,e.ref)(null);return(0,e.onMounted)((async()=>{a.value&&(a.value.volume=1,await r(t.callback,a.value))})),{isExtensionRegistered:n,handleCall:()=>{o.value||(a.value?.play(),a.value&&(a.value.volume=0),i())},sipAudioElement:a,initSip:r}}}),T=(0,w.A)(S,[["render",function(n,i,o,a,s,c){const d=(0,e.resolveComponent)("PhoneButton");return(0,e.openBlock)(),(0,e.createElementBlock)("div",null,[n.isExtensionRegistered?((0,e.openBlock)(),(0,e.createElementBlock)("div",t,[(0,e.createVNode)(d,{phoneStatusStyles:n.phoneStatusStyles,onClick:n.handleCall},null,8,["phoneStatusStyles","onClick"])])):(0,e.createCommentVNode)("v-if",!0),(0,e.createElementVNode)("video",r,null,512)])}]])}(),i}()}));